<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartCRM - 智能客戶關係管理系統</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0A0E1A 0%, #1a1f35 100%);
            color: #F1F5F9;
            overflow-x: hidden;
            min-height: 100vh;
        }
        .app { display: flex; min-height: 100vh; }
        .sidebar {
            width: 260px;
            background: rgba(19, 24, 38, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(148, 163, 184, 0.1);
            position: fixed;
            left: 0; top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s;
        }
        .sidebar.hidden-mobile { transform: translateX(-100%); }
        .logo-area { padding: 1.5rem; border-bottom: 1px solid rgba(148, 163, 184, 0.1); }
        .logo-title {
            font-size: 1.5rem; font-weight: 800;
            background: linear-gradient(135deg, #F97316, #FB923C);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .logo-subtitle { font-size: 0.8rem; color: #94A3B8; margin-top: 0.25rem; }
        .nav-item {
            padding: 0.85rem 1.5rem; cursor: pointer; transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex; align-items: center; gap: 0.75rem;
            color: #94A3B8; font-weight: 500; font-size: 0.95rem;
        }
        .nav-item:hover { background: rgba(249, 115, 22, 0.08); color: #F1F5F9; }
        .nav-item.active { background: rgba(249, 115, 22, 0.1); border-left-color: #F97316; color: #F1F5F9; }
        .main-content { margin-left: 260px; flex: 1; min-height: 100vh; display: flex; flex-direction: column; }
        .top-bar {
            padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(148, 163, 184, 0.08);
            background: rgba(19, 24, 38, 0.5); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 50;
        }
        .page-content { padding: 2rem; flex: 1; }
        .page-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.25rem; }
        .page-subtitle { color: #94A3B8; font-size: 0.9rem; }
        .card {
            background: rgba(19, 24, 38, 0.8); backdrop-filter: blur(10px);
            border-radius: 16px; padding: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.1); transition: all 0.3s;
        }
        .card:hover { border-color: rgba(249, 115, 22, 0.3); }
        .card-lift:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
        .stat-card {
            background: linear-gradient(135deg, rgba(19, 24, 38, 0.9), rgba(30, 41, 59, 0.9));
            border-radius: 16px; padding: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.1);
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: -20px; right: -20px;
            width: 120px; height: 120px;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.08), transparent);
            border-radius: 50%;
        }
        .btn-primary {
            background: linear-gradient(135deg, #F97316, #FB923C);
            color: white; padding: 0.65rem 1.25rem; border-radius: 10px;
            border: none; font-weight: 600; cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.25); font-size: 0.9rem;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(249, 115, 22, 0.35); }
        .btn-secondary {
            background: rgba(30, 41, 59, 0.6); color: #F1F5F9;
            padding: 0.65rem 1.25rem; border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            font-weight: 500; cursor: pointer; transition: all 0.3s; font-size: 0.9rem;
        }
        .btn-secondary:hover { background: rgba(30, 41, 59, 0.9); border-color: #F97316; }
        .btn-danger {
            background: rgba(239, 68, 68, 0.15); color: #EF4444;
            padding: 0.65rem 1.25rem; border-radius: 10px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            font-weight: 500; cursor: pointer; transition: all 0.3s; font-size: 0.9rem;
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.25); }
        .badge {
            display: inline-block; padding: 0.2rem 0.6rem; border-radius: 999px;
            font-size: 0.7rem; font-weight: 600; letter-spacing: 0.3px;
        }
        .badge-success { background: rgba(16,185,129,0.1); color: #10B981; border: 1px solid rgba(16,185,129,0.2); }
        .badge-warning { background: rgba(245,158,11,0.1); color: #F59E0B; border: 1px solid rgba(245,158,11,0.2); }
        .badge-danger { background: rgba(239,68,68,0.1); color: #EF4444; border: 1px solid rgba(239,68,68,0.2); }
        .badge-primary { background: rgba(249,115,22,0.1); color: #F97316; border: 1px solid rgba(249,115,22,0.2); }
        .badge-info { background: rgba(59,130,246,0.1); color: #3B82F6; border: 1px solid rgba(59,130,246,0.2); }
        .avatar {
            width: 42px; height: 42px; border-radius: 50%;
            background: linear-gradient(135deg, #F97316, #FB923C);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.1rem; color: white; flex-shrink: 0;
        }
        .avatar-sm { width: 32px; height: 32px; font-size: 0.85rem; }
        .progress-bar { width: 100%; height: 6px; background: rgba(30,41,59,0.9); border-radius: 999px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #F97316, #FB923C); border-radius: 999px; transition: width 0.6s ease; }
        input, textarea, select {
            background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px; padding: 0.65rem 0.75rem; color: #F1F5F9;
            width: 100%; font-family: inherit; transition: all 0.3s; font-size: 0.9rem;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #F97316; box-shadow: 0 0 0 3px rgba(249,115,22,0.1); }
        select option { background: #1a1f35; color: #F1F5F9; }
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center;
            z-index: 1000; animation: fadeIn 0.2s ease;
        }
        .modal-box {
            background: rgba(19, 24, 38, 0.98); backdrop-filter: blur(20px);
            border-radius: 16px; padding: 2rem; max-width: 560px; width: 92%;
            max-height: 85vh; overflow-y: auto;
            border: 1px solid rgba(148, 163, 184, 0.15);
            animation: slideUp 0.25s ease;
        }
        .side-panel {
            position: fixed; right: 0; top: 0; width: 420px; height: 100vh;
            background: rgba(19, 24, 38, 0.98); backdrop-filter: blur(20px);
            border-left: 1px solid rgba(148, 163, 184, 0.15);
            z-index: 200; overflow-y: auto; animation: slideIn 0.3s ease;
        }
        .pipeline-container { display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem; }
        .pipeline-stage {
            min-width: 260px; flex: 1;
            background: rgba(19, 24, 38, 0.6); border-radius: 12px; padding: 1rem;
            border: 1px solid rgba(148, 163, 184, 0.08);
        }
        .pipeline-stage.drag-over { border-color: #F97316; background: rgba(249,115,22,0.05); }
        .deal-card {
            background: rgba(30, 41, 59, 0.5); padding: 0.85rem; border-radius: 8px;
            margin-bottom: 0.6rem; cursor: grab; border: 1px solid transparent; transition: all 0.2s;
        }
        .deal-card:hover { border-color: rgba(249,115,22,0.3); }
        .deal-card.dragging { opacity: 0.5; cursor: grabbing; }
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast {
            padding: 0.75rem 1.25rem; border-radius: 10px; font-size: 0.875rem; font-weight: 500;
            animation: slideIn 0.3s ease; min-width: 240px;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .toast-success { background: rgba(16,185,129,0.95); color: white; }
        .toast-error { background: rgba(239,68,68,0.95); color: white; }
        .toast-info { background: rgba(59,130,246,0.95); color: white; }
        .timeline-item {
            padding: 0.75rem 0 0.75rem 1.5rem;
            border-left: 2px solid rgba(148,163,184,0.15);
            position: relative; margin-left: 0.5rem;
        }
        .timeline-item::before {
            content: ''; position: absolute; left: -5px; top: 1rem;
            width: 8px; height: 8px; border-radius: 50%; background: #F97316;
        }
        .vote-button {
            background: rgba(30,41,59,0.6); border: 1px solid rgba(148,163,184,0.2);
            border-radius: 8px; padding: 0.5rem 0.75rem;
            display: flex; align-items: center; gap: 0.4rem;
            cursor: pointer; transition: all 0.3s; font-weight: 600; color: #F1F5F9;
        }
        .vote-button:hover { background: #F97316; border-color: #F97316; }
        .search-box {
            background: rgba(30,41,59,0.5); border: 1px solid rgba(148,163,184,0.15);
            border-radius: 10px; padding: 0.55rem 1rem 0.55rem 2.5rem;
            color: #F1F5F9; font-size: 0.875rem; width: 280px; transition: all 0.3s;
        }
        .search-box:focus { border-color: #F97316; width: 360px; }
        .empty-state { text-align: center; padding: 3rem; color: #94A3B8; }
        .recording-indicator { width: 10px; height: 10px; background: #EF4444; border-radius: 50%; animation: pulse 1.5s ease-in-out infinite; }
        .overdue-caution { border-left: 3px solid #F59E0B !important; background: rgba(245,158,11,0.05) !important; }
        .overdue-warning { border-left: 3px solid #F97316 !important; background: rgba(249,115,22,0.08) !important; }
        .overdue-critical { border-left: 3px solid #EF4444 !important; background: rgba(239,68,68,0.1) !important; animation: pulseRed 2s ease-in-out infinite; }
        @keyframes pulseRed { 0%,100%{border-left-color:#EF4444} 50%{border-left-color:#F87171} }
        .schedule-card {
            background: rgba(30,41,59,0.5); padding: 1rem; border-radius: 10px;
            margin-bottom: 0.5rem; border: 1px solid rgba(148,163,184,0.1);
            transition: all 0.2s;
        }
        .schedule-card:hover { border-color: rgba(249,115,22,0.3); }
        .page-content.pipeline-full { padding: 0; }
        .calendar-month-shell {
            min-height: calc(100vh - 74px);
            background: rgba(8, 12, 26, 0.9);
            border-top: 1px solid rgba(148,163,184,0.08);
            display: flex;
            flex-direction: column;
        }
        .calendar-month-head {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(148,163,184,0.12);
            background: rgba(15,23,42,0.9);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .calendar-weekday-row {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            border-bottom: 1px solid rgba(148,163,184,0.14);
        }
        .calendar-weekday {
            padding: 0.6rem 0.45rem;
            text-align: center;
            color: #94A3B8;
            font-size: 0.78rem;
            font-weight: 600;
            border-right: 1px solid rgba(148,163,184,0.1);
        }
        .calendar-weekday:last-child { border-right: none; }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            flex: 1;
        }
        .calendar-cell {
            min-height: 126px;
            border-right: 1px solid rgba(148,163,184,0.1);
            border-bottom: 1px solid rgba(148,163,184,0.1);
            padding: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .calendar-cell:hover { background: rgba(249,115,22,0.08); }
        .calendar-cell.other-month { color: #64748B; background: rgba(15,23,42,0.25); }
        .calendar-cell.today .calendar-cell-date {
            color: #F97316;
            font-weight: 700;
        }
        .calendar-cell-date {
            font-size: 0.84rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: inline-block;
        }
        .calendar-event-chip {
            background: rgba(16,185,129,0.2);
            border: 1px solid rgba(16,185,129,0.35);
            color: #D1FAE5;
            border-radius: 6px;
            padding: 0.2rem 0.4rem;
            font-size: 0.72rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-cell-empty {
            font-size: 0.72rem;
            color: #64748B;
        }
        .day-editor-shell {
            min-height: calc(100vh - 74px);
            background: rgba(8, 12, 26, 0.92);
            padding: 1.25rem;
        }
        .day-editor-card {
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(148,163,184,0.15);
            border-radius: 14px;
            padding: 1rem;
        }
        .day-editor-form {
            display: grid;
            grid-template-columns: 1.2fr 0.7fr 0.7fr 1.3fr auto;
            gap: 0.65rem;
            align-items: end;
            margin-bottom: 0.65rem;
        }
        .day-editor-list {
            margin-top: 0.85rem;
            border-top: 1px solid rgba(148,163,184,0.12);
            padding-top: 0.85rem;
            display: grid;
            gap: 0.55rem;
        }
        .day-editor-item {
            background: rgba(30,41,59,0.6);
            border: 1px solid rgba(148,163,184,0.15);
            border-radius: 10px;
            padding: 0.7rem;
        }
        .day-editor-item-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        /* Overdue Banner */
        .overdue-banner {
            background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.25);
            border-radius: 10px; padding: 0.75rem 1rem; margin-bottom: 1rem;
        }
        /* Note List Row */
        .note-row {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem;
            border-radius: 8px; cursor: pointer; transition: background 0.15s;
            border-bottom: 1px solid rgba(148,163,184,0.08);
        }
        .note-row:hover { background: rgba(249,115,22,0.06); }
        .note-row .note-title { flex: 1; font-weight: 600; font-size: 0.85rem; color: #E2E8F0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
        .note-row .note-time { font-size: 0.75rem; color: #64748B; white-space: nowrap; }
        .note-row .note-arrow { color: #64748B; font-size: 0.8rem; }
        .note-type-select {
            background: rgba(30,41,59,0.6); border: 1px solid rgba(148,163,184,0.2);
            color: #CBD5E1; border-radius: 6px; padding: 0.15rem 0.25rem; font-size: 0.85rem;
            cursor: pointer; outline: none; width: auto; min-width: 42px; max-width: 50px; flex-shrink: 0;
        }
        .note-type-select:focus { border-color: #F97316; }
        .btn-complete {
            background: linear-gradient(135deg, #10B981, #34D399); color: white;
            padding: 0.4rem 0.75rem; border-radius: 8px; border: none;
            font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 0.8rem;
        }
        .btn-complete:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        .btn-reschedule {
            background: rgba(59,130,246,0.15); color: #3B82F6;
            padding: 0.4rem 0.75rem; border-radius: 8px;
            border: 1px solid rgba(59,130,246,0.3);
            font-weight: 500; cursor: pointer; transition: all 0.3s; font-size: 0.8rem;
        }
        .btn-reschedule:hover { background: rgba(59,130,246,0.25); }
        .progress-bar-lg { width: 100%; height: 10px; background: rgba(30,41,59,0.9); border-radius: 999px; overflow: hidden; }
        .progress-fill-lg { height: 100%; border-radius: 999px; transition: width 0.6s ease; }
        .locked-section {
            position: relative; background: rgba(30,41,59,0.3); border-radius: 10px;
            padding: 1rem; margin-bottom: 0.75rem; border: 1px solid rgba(148,163,184,0.1);
            overflow: hidden;
        }
        .locked-section::after {
            content: ''; position: absolute; inset: 0;
            background: rgba(10,14,26,0.55); backdrop-filter: blur(2px);
            border-radius: 10px; z-index: 1;
        }
        .locked-overlay {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 2;
            text-align: center; padding: 1rem;
        }
        .pro-badge {
            display: inline-block; padding: 0.15rem 0.5rem; border-radius: 999px;
            font-size: 0.6rem; font-weight: 700; letter-spacing: 0.5px;
            background: linear-gradient(135deg, #F97316, #FB923C);
            color: white; text-transform: uppercase;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes slideIn { from{opacity:0;transform:translateX(30px)} to{opacity:1;transform:translateX(0)} }
        .auth-input {
            width: 100%;
            padding: 0.7rem 0.85rem;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            color: #F1F5F9;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .auth-input:focus {
            border-color: #F97316;
        }
        .auth-input::placeholder {
            color: #64748B;
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show-mobile { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .calendar-month-head { padding: 0.75rem; }
            .calendar-cell { min-height: 88px; padding: 0.35rem; }
            .calendar-event-chip { font-size: 0.66rem; }
            .day-editor-shell { padding: 0.75rem; }
            .day-editor-form { grid-template-columns: 1fr; }
            .side-panel { width: 100%; }
            .search-box, .search-box:focus { width: 160px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, useMemo } = React;

        // ==================== UTILITIES ====================
        function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }
        function fmtDate(d) { return new Date(d).toLocaleDateString('zh-TW'); }
        function fmtTime(d) {
            var now = new Date(), t = new Date(d), diff = now - t, mins = Math.floor(diff/60000);
            if (mins < 1) return '剛剛';
            if (mins < 60) return mins + ' 分鐘前';
            var hrs = Math.floor(mins/60);
            if (hrs < 24) return hrs + ' 小時前';
            var days = Math.floor(hrs/24);
            if (days < 7) return days + ' 天前';
            return fmtDate(d);
        }
        function toInputDateTime(ts) {
            if (!ts) return '';
            var d = new Date(ts);
            var pad = function(n) { return String(n).padStart(2, '0'); };
            return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) + 'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
        }
        function fromInputDateTime(value) {
            if (!value) return null;
            var t = new Date(value).getTime();
            return isNaN(t) ? null : t;
        }

        // ==================== POCKETBASE CLIENT ====================
        const PB_URL = 'https://smartcrmback.zeabur.app';
        const pb = new PocketBase(PB_URL);

        function mapPBRecord(record) {
            return {
                ...record,
                createdAt: record.created ? new Date(record.created).getTime() : Date.now(),
                updatedAt: record.updated ? new Date(record.updated).getTime() : Date.now(),
            };
        }

        const pbClient = {
            register: function(email, password, passwordConfirm) {
                return pb.collection('users').create({ email, password, passwordConfirm });
            },
            login: function(email, password) {
                return pb.collection('users').authWithPassword(email, password);
            },
            logout: function() { pb.authStore.clear(); },
            isLoggedIn: function() { return pb.authStore.isValid; },
            getUser: function() { return pb.authStore.model; },
            getToken: function() { return pb.authStore.token; },

            listCustomers: function() {
                return pb.collection('customers').getFullList({
                    filter: 'owner = "' + pb.authStore.model.id + '"',
                    sort: '-created',
                }).then(function(records) { return records.map(mapPBRecord); });
            },
            createCustomer: function(data) {
                return pb.collection('customers').create({
                    ...data, owner: pb.authStore.model.id,
                }).then(mapPBRecord);
            },
            updateCustomer: function(id, data) {
                return pb.collection('customers').update(id, data).then(mapPBRecord);
            },
            deleteCustomer: function(id) {
                return pb.collection('customers').delete(id);
            },

            listDeals: function() {
                return pb.collection('deals').getFullList({
                    filter: 'owner = "' + pb.authStore.model.id + '"',
                    sort: '-created',
                }).then(function(records) { return records.map(mapPBRecord); });
            },
            createDeal: function(data) {
                return pb.collection('deals').create({
                    ...data, owner: pb.authStore.model.id,
                }).then(mapPBRecord);
            },
            updateDeal: function(id, data) {
                return pb.collection('deals').update(id, data).then(mapPBRecord);
            },
            deleteDeal: function(id) {
                return pb.collection('deals').delete(id);
            },

            listInteractions: function() {
                return pb.collection('interactions').getFullList({
                    filter: 'owner = "' + pb.authStore.model.id + '"',
                    sort: '-created',
                }).then(function(records) { return records.map(mapPBRecord); });
            },
            createInteraction: function(data) {
                return pb.collection('interactions').create({
                    ...data, owner: pb.authStore.model.id,
                }).then(mapPBRecord);
            },
            updateInteraction: function(id, data) {
                return pb.collection('interactions').update(id, data).then(mapPBRecord);
            },
            deleteInteraction: function(id) {
                return pb.collection('interactions').delete(id);
            },

            // --- Team (上下線) ---
            addTeamMember: async function(email) {
                var results = await pb.collection('users').getFullList({ filter: 'email = "' + email.trim() + '"' });
                if (!results.length) throw new Error('找不到此用戶，請確認 email 是否正確');
                var target = results[0];
                if (target.id === pb.authStore.model.id) throw new Error('不能新增自己為下線');
                if (target.invitedBy) throw new Error('此用戶已有上線');
                return pb.collection('users').update(target.id, { invitedBy: pb.authStore.model.id });
            },
            removeTeamMember: function(userId) {
                return pb.collection('users').update(userId, { invitedBy: '' });
            },
            listTeamMembers: function() {
                return pb.collection('users').getFullList({
                    filter: 'invitedBy = "' + pb.authStore.model.id + '"',
                    sort: '-created',
                });
            },
            listAllTeamData: async function() {
                var members = await pb.collection('users').getFullList({
                    filter: 'invitedBy = "' + pb.authStore.model.id + '"',
                    sort: '-created',
                });
                return Promise.all(members.map(async function(member) {
                    var [customers, deals] = await Promise.all([
                        pb.collection('customers').getFullList({
                            filter: 'owner = "' + member.id + '"',
                        }).then(function(r) { return r.map(mapPBRecord); }),
                        pb.collection('deals').getFullList({
                            filter: 'owner = "' + member.id + '"',
                        }).then(function(r) { return r.map(mapPBRecord); }),
                    ]);
                    var closedDeals = deals.filter(function(d) { return d.stage === 'closed'; });
                    return {
                        id: member.id,
                        name: member.name || member.email.split('@')[0],
                        email: member.email,
                        deals: closedDeals.length,
                        value: closedDeals.reduce(function(s, d) { return s + (d.value || 0); }, 0),
                        totalDeals: deals.length,
                        totalCustomers: customers.length,
                        customers: customers,
                        allDeals: deals,
                    };
                }));
            },
        };

        const STATUS_MAP = {
            new:        { label: '🆕 新名單',    badge: 'badge-info' },
            contacted:  { label: '📞 已聯絡',    badge: 'badge-warning' },
            following:  { label: '🔥 跟進中',    badge: 'badge-danger' },
            closed:     { label: '✅ 已成交',    badge: 'badge-success' },
        };
        function getStatusInfo(status) {
            return STATUS_MAP[status] || { label: status, badge: 'badge-info' };
        }

        const NEXT_CONTACT_SUGGESTION = {
            'new->contacted': 1,
            'contacted->following': 3,
            'following->following': 3,
            'following->closed': 7,
        };
        function getSuggestedNextContact(fromStatus, toStatus) {
            var days = NEXT_CONTACT_SUGGESTION[fromStatus + '->' + toStatus];
            if (!days) return null;
            var d = new Date();
            d.setDate(d.getDate() + days);
            d.setHours(10, 0, 0, 0);
            return d.getTime();
        }
        function getOverdueDays(nextContact) {
            if (!nextContact) return 0;
            var now = new Date(); now.setHours(0, 0, 0, 0);
            var diff = now.getTime() - nextContact;
            return diff > 0 ? Math.ceil(diff / day) : 0;
        }
        function getOverdueLevel(overdueDays) {
            if (overdueDays >= 7) return 'critical';
            if (overdueDays >= 3) return 'warning';
            if (overdueDays >= 1) return 'caution';
            return 'none';
        }
        function formatWeekday(ts) {
            return new Date(ts).toLocaleDateString('zh-TW', { weekday: 'short', month: 'numeric', day: 'numeric' });
        }
        function getCustomerScore(customer, interactions, deals) {
            var DAY_MS = 86400000;
            var now = Date.now();
            var score = 50;

            var lastTouch = customer.lastContact || customer.createdAt || now;
            var idleDays = Math.floor((now - lastTouch) / DAY_MS);
            if (idleDays <= 2) score += 12;
            else if (idleDays <= 7) score += 4;
            else if (idleDays >= 21) score -= 12;

            var overdueDays = getOverdueDays(customer.nextContact);
            if (overdueDays >= 7) score -= 20;
            else if (overdueDays >= 3) score -= 12;
            else if (overdueDays >= 1) score -= 6;
            else if (customer.nextContact) score += 4;

            if (customer.status === 'closed') score += 18;
            else if (customer.status === 'following') score += 8;
            else if (customer.status === 'new') score -= 4;

            if (customer.priority === 'high') score += 8;
            else if (customer.priority === 'mid') score += 3;

            var recentInteractions = interactions.filter(function(i) { return i.createdAt >= now - 30 * DAY_MS; }).length;
            if (recentInteractions >= 4) score += 10;
            else if (recentInteractions === 0) score -= 8;

            var openValue = deals.filter(function(d) { return d.stage !== 'closed'; }).reduce(function(s, d) { return s + (d.value || 0); }, 0);
            if (openValue >= 100000) score += 8;
            else if (openValue >= 30000) score += 4;

            if (score < 0) return 0;
            if (score > 100) return 100;
            return Math.round(score);
        }
        function getScoreInfo(score) {
            if (score >= 80) return { label: '高價值', tone: '#10B981', bg: 'rgba(16,185,129,0.12)', border: '1px solid rgba(16,185,129,0.28)' };
            if (score >= 60) return { label: '穩定', tone: '#F59E0B', bg: 'rgba(245,158,11,0.12)', border: '1px solid rgba(245,158,11,0.28)' };
            return { label: '待挽回', tone: '#EF4444', bg: 'rgba(239,68,68,0.12)', border: '1px solid rgba(239,68,68,0.28)' };
        }
        function getNextActionText(customer, score) {
            var overdueDays = getOverdueDays(customer.nextContact);
            if (overdueDays > 0) return '優先處理逾期跟進';
            if (!customer.nextContact) return '安排下次聯繫時間';
            if (score < 60) return '先做需求釐清與痛點確認';
            if (customer.status === 'following') return '推進提案與成交條件';
            if (customer.status === 'new') return '完成首次接觸';
            return '維持節奏，準備下一步';
        }

        // ==================== LOCAL STORAGE HOOK ====================
        function useLocalStorage(key, defaultValue) {
            const fullKey = 'smartcrm_' + key;
            const [value, setValue] = useState(function() {
                try {
                    const stored = localStorage.getItem(fullKey);
                    if (stored === null || stored === undefined) return defaultValue;
                    return JSON.parse(stored);
                } catch (e) {
                    console.warn('localStorage parse error for key:', fullKey, e);
                    localStorage.removeItem(fullKey);
                    return defaultValue;
                }
            });
            useEffect(function() {
                try {
                    localStorage.setItem(fullKey, JSON.stringify(value));
                } catch (e) {
                    console.warn('localStorage write error:', e);
                }
            }, [fullKey, value]);
            return [value, setValue];
        }

        // 清除所有 SmartCRM 資料
        function resetAllData() {
            Object.keys(localStorage).forEach(function(key) {
                if (key.startsWith('smartcrm_')) localStorage.removeItem(key);
            });
            window.location.reload();
        }

        // ==================== TOAST SYSTEM ====================
        let toastId = 0;
        function ToastProvider({ children }) {
            const [toasts, setToasts] = useState([]);
            const addToast = useCallback((message, type = 'success') => {
                const id = ++toastId;
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 2500);
            }, []);
            return (
                <ToastContext.Provider value={addToast}>
                    {children}
                    <div className="toast-container">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast toast-${t.type}`}>
                                <span>{t.type === 'success' ? '✓' : t.type === 'error' ? '✕' : 'ℹ'}</span>
                                <span>{t.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        }
        const ToastContext = React.createContext(() => {});
        const useToast = () => React.useContext(ToastContext);

        // ==================== AUTH CONTEXT ====================
        const AuthContext = React.createContext(null);
        const useAuth = () => React.useContext(AuthContext);

        function AuthProvider({ children }) {
            const [user, setUser] = useState(pb.authStore.isValid ? pb.authStore.model : null);
            const [loading, setLoading] = useState(true);

            useEffect(function() {
                if (pb.authStore.isValid) {
                    setUser(pb.authStore.model);
                } else {
                    setUser(null);
                }
                setLoading(false);

                var unsubscribe = pb.authStore.onChange(function(token, model) {
                    setUser(model);
                });
                return function() { if (typeof unsubscribe === 'function') unsubscribe(); };
            }, []);

            const login = async function(email, password) {
                var authData = await pbClient.login(email, password);
                setUser(authData.record);
                return authData;
            };

            const register = async function(email, password, passwordConfirm) {
                await pbClient.register(email, password, passwordConfirm);
                return login(email, password);
            };

            const logout = function() {
                pbClient.logout();
                setUser(null);
            };

            if (loading) {
                return (
                    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <p style={{ color: '#94A3B8', fontSize: '1.1rem' }}>載入中...</p>
                    </div>
                );
            }

            return (
                <AuthContext.Provider value={{ user, login, register, logout }}>
                    {children}
                </AuthContext.Provider>
            );
        }

        // ==================== SEED DATA ====================
        const now = Date.now();
        const day = 86400000;
        var todayAt = function(h, m) { var d = new Date(); d.setHours(h, m || 0, 0, 0); return d.getTime(); };
        const seedCustomers = [
            { id: 'c1', name: '王小芸', gender: 'female', ageRange: '25-34', city: '台北', source: 'Instagram', preference: 'LINE', email: 'xiaoyun@example.com', phone: '0912-345-678', status: 'following', plan: '安排試用體驗與優惠方案', tags: ['美妝','高互動'], priority: 'high', budget: '5-20', createdAt: now - 30*day, updatedAt: now - 2*3600000, lastContact: now - 2*3600000, nextContact: todayAt(14) },
            { id: 'c2', name: '陳志豪', gender: 'male', ageRange: '35-44', city: '新北', source: '門市到店', preference: '電話', email: 'zhihao@example.com', phone: '0922-111-222', status: 'contacted', plan: '安排到店回訪與產品比較', tags: ['家電'], priority: 'mid', budget: '0-5', createdAt: now - 25*day, updatedAt: now - 1*day, lastContact: now - 1*day, nextContact: todayAt(10) },
            { id: 'c3', name: '林雅婷', gender: 'female', ageRange: '25-34', city: '桃園', source: '官網表單', preference: 'Email', email: 'yating@example.com', phone: '0955-333-444', status: 'new', plan: '寄送產品型錄與使用案例', tags: ['新名單'], priority: 'low', budget: '', createdAt: now - 20*day, updatedAt: now - 4*day, lastContact: null, nextContact: now + 1*day },
            { id: 'c4', name: '張佳穎', gender: 'female', ageRange: '18-24', city: '台中', source: '朋友推薦', preference: 'LINE', email: 'jiaying@example.com', phone: '0933-888-999', status: 'following', plan: '安排諮詢與價格說明', tags: ['健身'], priority: 'mid', budget: '5-20', createdAt: now - 15*day, updatedAt: now - 5*day, lastContact: now - 5*day, nextContact: now - 2*day },
            { id: 'c5', name: '李大偉', gender: 'male', ageRange: '45-54', city: '高雄', source: '活動現場', preference: '電話', email: 'dawei@example.com', phone: '0988-222-333', status: 'closed', plan: '後續滿意度追蹤', tags: ['已成交'], priority: 'high', budget: '20-50', createdAt: now - 40*day, updatedAt: now - 1*day, lastContact: now - 1*day, nextContact: null },
            { id: 'c6', name: '周欣怡', gender: 'female', ageRange: '35-44', city: '台南', source: 'Google 搜尋', preference: 'Email', email: 'xinyi@example.com', phone: '0977-666-555', status: 'following', plan: '安排下週線上試用教學', tags: ['VIP'], priority: 'high', budget: '50+', createdAt: now - 10*day, updatedAt: now - 6*3600000, lastContact: now - 6*3600000, nextContact: now - 8*day },
        ];
        const seedDeals = [
            { id: 'd1', customerId: 'c4', title: 'momo 年度合約', value: 25000, stage: 'lead', expectedClose: now + 14*day, notes: '初步接洽中', createdAt: now - 10*day },
            { id: 'd2', customerId: 'c2', title: '鴻海 ERP 整合', value: 30000, stage: 'contact', expectedClose: now + 10*day, notes: '已安排產品 Demo', createdAt: now - 8*day },
            { id: 'd3', customerId: 'c1', title: 'Apple 企業方案', value: 50000, stage: 'proposal', expectedClose: now + 5*day, notes: '報價已送出，等待回覆', createdAt: now - 15*day },
            { id: 'd4', customerId: 'c3', title: 'Google 雲端專案', value: 80000, stage: 'negotiation', expectedClose: now + 3*day, notes: '價格談判中', createdAt: now - 20*day },
            { id: 'd5', customerId: 'c5', title: 'Microsoft 授權', value: 120000, stage: 'closed', expectedClose: now - 2*day, notes: '已簽約', createdAt: now - 30*day },
            { id: 'd6', customerId: 'c6', title: '台積電 AI 平台', value: 200000, stage: 'proposal', expectedClose: now + 7*day, notes: '高層已同意初步方案', createdAt: now - 5*day },
        ];
        const seedInteractions = [
            { id: 'i1', customerId: 'c1', type: 'call', title: '年度合約討論', content: '討論年度合約細節，客戶對價格方案表示滿意，預計下週提供正式報價單。客戶希望能在月底前確認合作方案。', createdAt: now - 2*3600000 },
            { id: 'i2', customerId: 'c2', type: 'email', title: '寄出 Demo 邀請', content: '寄出產品 Demo 邀請函，附上三個可選時段。', createdAt: now - 1*day },
            { id: 'i3', customerId: 'c3', type: 'meeting', title: '需求訪談會議', content: '視訊會議：需求訪談，客戶需要雲端整合方案。主要痛點是目前系統太分散，需要統一管理客戶資料。預算約 50 萬。', createdAt: now - 4*day },
            { id: 'i4', customerId: 'c5', type: 'note', title: '合約簽署完成', content: '合約已簽署，下月開始執行。需準備導入計畫與教育訓練時程。', createdAt: now - 1*day },
            { id: 'i5', customerId: 'c6', type: 'call', title: 'AI 平台需求確認', content: '與張總通話 20 分鐘，確認 AI 平台需求規格。需要自然語言處理和數據分析功能。', createdAt: now - 6*3600000 },
            { id: 'i6', customerId: 'c4', type: 'email', title: '初步合作提案', content: '寄出初步合作提案，包含三種方案比較表。', createdAt: now - 5*day },
            { id: 'i7', customerId: 'c1', type: 'note', title: '競品評估中', content: '客戶內部正在評估競品方案，需盡快跟進。主要競品是 Salesforce 和 HubSpot，我們的優勢在於在地化服務和價格。', createdAt: now - 1*day },
        ];

        const seedPlugins = [
            { id: 'p1', name: '進階報表分析', description: '自動生成 50+ 種商業報表', rating: 4.8, reviews: 2341, price: 29, category: '數據分析', icon: '📊' },
            { id: 'p2', name: 'LINE 官方帳號整合', description: '在 CRM 內直接管理 LINE 訊息', rating: 4.9, reviews: 1876, price: 39, category: '通訊整合', icon: '📱' },
            { id: 'p3', name: 'WhatsApp Business', description: 'WhatsApp 雙向訊息同步', rating: 4.7, reviews: 1534, price: 35, category: '通訊整合', icon: '💬' },
            { id: 'p4', name: 'AI 客戶分群', description: '智能分析客戶行為並自動分類', rating: 4.6, reviews: 892, price: 49, category: 'AI 助手', icon: '🤖' },
            { id: 'p5', name: 'Email 行銷自動化', description: '排程寄送個人化郵件', rating: 4.5, reviews: 1203, price: 25, category: '行銷', icon: '📧' },
            { id: 'p6', name: '電子簽章', description: '合約線上簽署，即時追蹤', rating: 4.8, reviews: 967, price: 19, category: '文件管理', icon: '✍️' },
                    { id: 'p7', name: '跟進策略引擎', description: '自動生成最佳跟進時間、推薦聯繫話術、歷史成功模式分析', rating: 4.9, reviews: 620, price: 59, category: 'AI 工具', icon: '🧠' },
            { id: 'p8', name: '客戶價值評估', description: '預估成交機率、客戶終身價值計算、同類客戶對比分析', rating: 4.8, reviews: 514, price: 69, category: '資料分析', icon: '💎' },
];
        const seedWishes = [
            { id: 'w1', title: 'LINE 官方帳號整合', votes: 1234, comments: 89, status: 'planned', category: '通訊整合', author: '王小明', daysAgo: 2, description: '希望能在 CRM 內直接回覆 LINE 客戶訊息' },
            { id: 'w2', title: '房仲專用模組', votes: 892, comments: 45, status: 'evaluating', category: '產業專用', author: '李經理', daysAgo: 5, description: '需要物件配對、帶看記錄等房仲業專屬功能' },
            { id: 'w3', title: 'Instagram 私訊整合', votes: 756, comments: 67, status: 'planned', category: '通訊整合', author: '張小姐', daysAgo: 3, description: '可在 CRM 內管理 IG 私訊' },
            { id: 'w4', title: 'AI 自動回覆客戶', votes: 623, comments: 34, status: 'voting', category: 'AI 助手', author: '陳先生', daysAgo: 7, description: '根據歷史對話自動生成回覆建議' },
            { id: 'w5', title: 'AI 智能分析', votes: 534, comments: 28, status: 'evaluating', category: 'AI 助手', author: '官方團隊', daysAgo: 1, description: '自動生成會議摘要、關鍵字標註、情緒分析、待辦事項提取' },
            { id: 'w6', title: '跟進提醒系統', votes: 478, comments: 52, status: 'evaluating', category: '自動化', author: '官方團隊', daysAgo: 1, description: '智能提醒跟進客戶、設定排程、到期自動通知' },
            { id: 'w7', title: '客戶管理進階版', votes: 412, comments: 31, status: 'evaluating', category: '自動化', author: '官方團隊', daysAgo: 1, description: '跟進策略模板、客戶價值評估、進度統計分析' },
        ];

        // ==================== MAIN APP ====================
        function App() {
            return (
                <AuthProvider>
                    <ToastProvider>
                        <AppRouter />
                    </ToastProvider>
                </AuthProvider>
            );
        }

        function AppRouter() {
            const { user } = useAuth();
            if (!user) return <AuthScreen />;
            return <MainApp />;
        }

        // ==================== AUTH SCREEN (LOGIN / REGISTER) ====================
        function AuthScreen() {
            const [mode, setMode] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const { login, register } = useAuth();

            const handleSubmit = async function(e) {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (mode === 'register') {
                        if (password.length < 8) { setError('密碼至少需要 8 個字元'); setLoading(false); return; }
                        if (password !== passwordConfirm) { setError('兩次密碼輸入不一致'); setLoading(false); return; }
                        await register(email, password, passwordConfirm);
                    } else {
                        await login(email, password);
                    }
                } catch (err) {
                    var msg = '操作失敗';
                    if (err && err.response && err.response.message) msg = err.response.message;
                    else if (err && err.message) msg = err.message;
                    if (msg === 'Failed to authenticate.') msg = '帳號或密碼錯誤';
                    setError(msg);
                }
                setLoading(false);
            };

            const switchMode = function() { setMode(mode === 'login' ? 'register' : 'login'); setError(''); };

            return (
                <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    <div style={{ maxWidth: 420, width: '90%' }}>
                        <div style={{ textAlign: 'center', marginBottom: '2rem' }}>
                            <h1 className="logo-title" style={{ fontSize: '2.5rem', marginBottom: '0.5rem' }}>SmartCRM</h1>
                            <p style={{ color: '#94A3B8', fontSize: '1.05rem' }}>智能客戶關係管理系統</p>
                        </div>
                        <div className="card" style={{ padding: '2rem' }}>
                            <h2 style={{ fontWeight: 700, fontSize: '1.25rem', marginBottom: '1.5rem', textAlign: 'center' }}>
                                {mode === 'login' ? '登入帳號' : '建立帳號'}
                            </h2>
                            {error && (
                                <div style={{ background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: 8, padding: '0.75rem', marginBottom: '1rem', color: '#EF4444', fontSize: '0.85rem' }}>
                                    {error}
                                </div>
                            )}
                            <form onSubmit={handleSubmit}>
                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.4rem', fontSize: '0.85rem', color: '#94A3B8' }}>電子郵件</label>
                                    <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="your@email.com" required
                                        className="auth-input" />
                                </div>
                                <div style={{ marginBottom: '1rem' }}>
                                    <label style={{ display: 'block', marginBottom: '0.4rem', fontSize: '0.85rem', color: '#94A3B8' }}>密碼</label>
                                    <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="至少 8 個字元" required
                                        className="auth-input" />
                                </div>
                                {mode === 'register' && (
                                    <div style={{ marginBottom: '1rem' }}>
                                        <label style={{ display: 'block', marginBottom: '0.4rem', fontSize: '0.85rem', color: '#94A3B8' }}>確認密碼</label>
                                        <input type="password" value={passwordConfirm} onChange={e => setPasswordConfirm(e.target.value)} placeholder="再次輸入密碼" required
                                            className="auth-input" />
                                    </div>
                                )}
                                <button type="submit" className="btn-primary" disabled={loading}
                                    style={{ width: '100%', padding: '0.75rem', fontSize: '1rem', marginTop: '0.5rem', cursor: loading ? 'wait' : 'pointer' }}>
                                    {loading ? '處理中...' : (mode === 'login' ? '登入' : '註冊')}
                                </button>
                            </form>
                            <p style={{ textAlign: 'center', marginTop: '1.25rem', fontSize: '0.85rem', color: '#94A3B8' }}>
                                {mode === 'login' ? '還沒有帳號？' : '已有帳號？'}
                                <span onClick={switchMode}
                                    style={{ color: '#F97316', cursor: 'pointer', marginLeft: '0.25rem', fontWeight: 600 }}>
                                    {mode === 'login' ? '立即註冊' : '返回登入'}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== MAIN APP SHELL ====================
        function MainApp() {
            const { user, logout } = useAuth();
            const [currentView, setCurrentView] = useState('dashboard');
            const [customers, setCustomers] = useState([]);
            const [deals, setDeals] = useState([]);
            const [interactions, setInteractions] = useState([]);
            const [team, setTeam] = useState([]);
            const [wishes, setWishes] = useLocalStorage('wishes', seedWishes);
            const [customerFieldTemplate, setCustomerFieldTemplate] = useLocalStorage('customerFieldTemplate', []);
            const [scheduleFieldTemplate, setScheduleFieldTemplate] = useLocalStorage('scheduleFieldTemplate', []);
            const [dataLoading, setDataLoading] = useState(true);
            const [globalSearch, setGlobalSearch] = useState('');
            const [mobileMenu, setMobileMenu] = useState(false);
            const [customerSort, setCustomerSort] = useState('default');
            const [customerFocusFilter, setCustomerFocusFilter] = useState(null);
            const toast = useToast();
            const voteWish = (id) => { setWishes(prev => prev.map(w => w.id === id ? { ...w, votes: w.votes + 1 } : w)); toast('投票成功 +1'); };
            const voteWishByTitle = (title) => { setWishes(prev => prev.map(w => w.title === title ? { ...w, votes: w.votes + 1 } : w)); toast('已催更 +1'); };

            // -- 從 PocketBase 載入資料 --
            const reloadTeam = async function() {
                try {
                    var teamData = await pbClient.listAllTeamData();
                    setTeam(teamData);
                } catch (err) { console.warn('載入團隊資料失敗:', err); }
            };
            const loadAllData = async function() {
                try {
                    var [c, d, i] = await Promise.all([
                        pbClient.listCustomers(),
                        pbClient.listDeals(),
                        pbClient.listInteractions(),
                    ]);
                    setCustomers(c);
                    setDeals(d);
                    setInteractions(i);
                    reloadTeam();
                } catch (err) {
                    console.error('載入資料失敗:', err);
                    toast('載入資料失敗，請重新整理', 'error');
                }
                setDataLoading(false);
            };
            useEffect(function() { loadAllData(); }, []);

            const handleAddTeamMember = async function(email) {
                await pbClient.addTeamMember(email);
                toast('已新增下線');
                reloadTeam();
            };
            const handleRemoveTeamMember = async function(userId) {
                await pbClient.removeTeamMember(userId);
                toast('已移除下線');
                reloadTeam();
            };

            // -- CRUD: Customers --
            const addCustomer = async function(c) {
                try {
                    var tpl = Array.isArray(customerFieldTemplate) ? customerFieldTemplate : [];
                    var customValues = {};
                    tpl.forEach(function(f) { customValues[f.id] = ''; });
                    if (c.customValues) customValues = { ...customValues, ...c.customValues };
                    var payload = { ...c };
                    delete payload.id;
                    payload.lastContact = c.lastContact || null;
                    payload.nextContact = c.nextContact || null;
                    payload.customFieldSchema = c.customFieldSchema || tpl;
                    payload.customValues = customValues;
                    payload.tags = payload.tags || [];
                    var created = await pbClient.createCustomer(payload);
                    setCustomers(prev => [created, ...prev]);
                    toast('客戶已新增');
                    return created;
                } catch (err) { console.error(err); toast('新增客戶失敗', 'error'); }
            };
            const updateCustomer = async function(id, data) {
                try {
                    var updated = await pbClient.updateCustomer(id, data);
                    setCustomers(prev => prev.map(c => c.id === id ? { ...c, ...updated } : c));
                    toast('客戶已更新');
                } catch (err) { console.error(err); toast('更新客戶失敗', 'error'); }
            };
            const deleteCustomer = async function(id) {
                try {
                    await pbClient.deleteCustomer(id);
                    setCustomers(prev => prev.filter(c => c.id !== id));
                    // 刪除相關 deals 和 interactions
                    var relatedDeals = deals.filter(d => d.customerId === id);
                    var relatedInters = interactions.filter(i => i.customerId === id);
                    await Promise.all([
                        ...relatedDeals.map(d => pbClient.deleteDeal(d.id).catch(function(){})),
                        ...relatedInters.map(i => pbClient.deleteInteraction(i.id).catch(function(){})),
                    ]);
                    setDeals(prev => prev.filter(d => d.customerId !== id));
                    setInteractions(prev => prev.filter(i => i.customerId !== id));
                    toast('客戶已刪除');
                } catch (err) { console.error(err); toast('刪除客戶失敗', 'error'); }
            };
            const moveCustomer = (dragId, targetId) => {
                setCustomers(prev => {
                    const arr = [...prev];
                    const from = arr.findIndex(c => c.id === dragId);
                    const to = arr.findIndex(c => c.id === targetId);
                    if (from < 0 || to < 0 || from === to) return prev;
                    const [item] = arr.splice(from, 1);
                    arr.splice(to, 0, item);
                    return arr;
                });
            };

            // -- CRUD: Deals --
            const addDeal = async function(d) {
                try {
                    var payload = { ...d }; delete payload.id;
                    var created = await pbClient.createDeal(payload);
                    setDeals(prev => [created, ...prev]);
                    toast('交易已新增');
                } catch (err) { console.error(err); toast('新增交易失敗', 'error'); }
            };
            const updateDeal = async function(id, data) {
                try {
                    var updated = await pbClient.updateDeal(id, data);
                    setDeals(prev => prev.map(d => d.id === id ? { ...d, ...updated } : d));
                } catch (err) { console.error(err); toast('更新交易失敗', 'error'); }
            };
            const deleteDeal = async function(id) {
                try {
                    await pbClient.deleteDeal(id);
                    setDeals(prev => prev.filter(d => d.id !== id));
                    toast('交易已刪除');
                } catch (err) { console.error(err); toast('刪除交易失敗', 'error'); }
            };

            // -- CRUD: Interactions --
            const addInteraction = async function(inter) {
                try {
                    var payload = { ...inter }; delete payload.id;
                    var created = await pbClient.createInteraction(payload);
                    setInteractions(prev => [created, ...prev]);
                    return created;
                } catch (err) { console.error(err); toast('新增互動記錄失敗', 'error'); }
            };
            const updateInteraction = async function(id, data) {
                try {
                    var updated = await pbClient.updateInteraction(id, data);
                    setInteractions(prev => prev.map(i => i.id === id ? { ...i, ...updated } : i));
                } catch (err) { console.error(err); toast('更新互動記錄失敗', 'error'); }
            };
            const getCustomer = (id) => customers.find(c => c.id === id);

            // -- 完成聯繫 / 改期 / 跳轉排程 --
            const [completeContactModal, setCompleteContactModal] = useState(null);
            const [rescheduleModal, setRescheduleModal] = useState(null);
            const [addScheduleModal, setAddScheduleModal] = useState(null);
            const [focusCustomerId, setFocusCustomerId] = useState(null);

            const completeContact = async function(customerId, data) {
                try {
                    var updateData = {
                        lastContact: Date.now(),
                        status: data.newStatus,
                        nextContact: data.nextContactDate,
                        plan: data.nextContactReason || '',
                    };
                    var updatedC = await pbClient.updateCustomer(customerId, updateData);
                    setCustomers(prev => prev.map(c => c.id === customerId ? { ...c, ...updatedC } : c));
                    var interPayload = {
                        customerId: customerId,
                        type: data.contactMethod,
                        title: data.summary || '已完成聯繫',
                        content: '',
                    };
                    var newInter = await pbClient.createInteraction(interPayload);
                    setInteractions(prev => [newInter, ...prev]);
                    toast('已完成聯繫 ✓');
                    setCompleteContactModal(null);
                } catch (err) { console.error(err); toast('完成聯繫失敗', 'error'); }
            };
            const rescheduleCustomer = async function(customerId, newDate) {
                try {
                    var updated = await pbClient.updateCustomer(customerId, { nextContact: newDate });
                    setCustomers(prev => prev.map(c => c.id === customerId ? { ...c, ...updated } : c));
                    toast('已改期');
                    setRescheduleModal(null);
                } catch (err) { console.error(err); toast('改期失敗', 'error'); }
            };
            const addSchedule = async function(customerId, { date, title, note, customValues }) {
                try {
                    var updated = await pbClient.updateCustomer(customerId, { nextContact: date, scheduleTitle: title || '', scheduleNote: note || '', scheduleCustomValues: customValues || {} });
                    setCustomers(prev => prev.map(c => c.id === customerId ? { ...c, ...updated } : c));
                    toast('排程已新增');
                    setAddScheduleModal(null);
                } catch (err) { console.error(err); toast('新增排程失敗', 'error'); }
            };
            const removeSchedule = async function(customerId) {
                try {
                    var updated = await pbClient.updateCustomer(customerId, { nextContact: null, scheduleTitle: '', scheduleNote: '', scheduleCustomValues: {} });
                    setCustomers(prev => prev.map(c => c.id === customerId ? { ...c, ...updated } : c));
                    toast('排程已刪除');
                } catch (err) { console.error(err); toast('刪除排程失敗', 'error'); }
            };
            const deleteInteraction = async function(id) {
                try {
                    await pbClient.deleteInteraction(id);
                    setInteractions(prev => prev.filter(i => i.id !== id));
                    toast('筆記已刪除');
                } catch (err) { console.error(err); toast('刪除筆記失敗', 'error'); }
            };

            const ctx = { user, customers, deals, interactions, team, wishes, addCustomer, updateCustomer, deleteCustomer, addDeal, updateDeal, deleteDeal, addInteraction, updateInteraction, deleteInteraction, getCustomer, voteWish, voteWishByTitle, setWishes, toast, globalSearch, setCurrentView, customerSort, setCustomerSort, moveCustomer, completeContact, setCompleteContactModal, completeContactModal, rescheduleCustomer, setRescheduleModal, rescheduleModal, addSchedule, removeSchedule, setAddScheduleModal, addScheduleModal, focusCustomerId, setFocusCustomerId, customerFocusFilter, setCustomerFocusFilter, customerFieldTemplate, setCustomerFieldTemplate, scheduleFieldTemplate, setScheduleFieldTemplate, handleAddTeamMember, handleRemoveTeamMember, reloadTeam };

            const voiceLocked = true;
            const navItems = [
                { id: 'dashboard', label: '智能工作台', icon: '🏠' },
                { id: 'customers', label: '客戶管理', icon: '👥' },
                { id: 'pipeline', label: '名單排程', icon: '🗓️' },
                { id: 'team', label: '團隊管理', icon: '👔' },
            ];

            if (dataLoading) {
                return (
                    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <div style={{ textAlign: 'center' }}>
                            <h1 className="logo-title" style={{ fontSize: '1.5rem', marginBottom: '1rem' }}>SmartCRM</h1>
                            <p style={{ color: '#94A3B8' }}>載入資料中...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app">
                    <div className={`sidebar ${mobileMenu ? 'show-mobile' : ''}`}>
                        <div className="logo-area">
                            <h1 className="logo-title">SmartCRM</h1>
                            <p className="logo-subtitle">智能客戶關係管理</p>
                        </div>
                        <nav style={{ padding: '0.75rem 0' }}>
                            {navItems.map(item => (
                                <div key={item.id} className={`nav-item ${currentView === item.id ? 'active' : ''}`}
                                    onClick={() => {
                                        if (item.locked) { toast('語音記錄已暫時鎖定'); return; }
                                        setCurrentView(item.id);
                                        setMobileMenu(false);
                                    }}
                                    style={item.locked ? { opacity: 0.5, cursor: 'not-allowed' } : undefined}>
                                    <span style={{ fontSize: '1.15rem' }}>{item.icon}</span>
                                    <span>{item.label}</span>
                                </div>
                            ))}
                        </nav>
                        <div style={{ padding: '1rem 1.5rem', borderTop: '1px solid rgba(148,163,184,0.1)', marginTop: 'auto' }}>
                            <div style={{ display: 'flex', gap: '0.4rem', flexWrap: 'wrap', marginBottom: '0.6rem' }}>
                                <button className="btn-secondary" style={{ padding: '0.25rem 0.5rem', fontSize: '0.72rem' }} onClick={() => setCurrentView('store')}>功能商店</button>
                                <button className="btn-secondary" style={{ padding: '0.25rem 0.5rem', fontSize: '0.72rem' }} onClick={() => setCurrentView('wishes')}>許願池</button>
                                <button className="btn-secondary" style={{ padding: '0.25rem 0.5rem', fontSize: '0.72rem', opacity: 0.6 }} onClick={() => toast('語音記錄已暫時鎖定')}>語音</button>
                            </div>
                            <p style={{ color: '#64748B', fontSize: '0.7rem' }}>SmartCRM Demo v1.0</p>
                        </div>
                    </div>

                    <div className="main-content">
                        <div className="top-bar">
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <button onClick={() => setMobileMenu(!mobileMenu)}
                                    style={{ display: 'none', background: 'none', border: 'none', color: '#F1F5F9', fontSize: '1.5rem', cursor: 'pointer' }}
                                    className="mobile-menu-btn">☰</button>
                                <div style={{ position: 'relative' }}>
                                    <span style={{ position: 'absolute', left: '0.75rem', top: '50%', transform: 'translateY(-50%)', color: '#94A3B8' }}>🔍</span>
                                    <input type="text" className="search-box" placeholder="搜尋客戶、交易..."
                                        value={globalSearch} onChange={e => setGlobalSearch(e.target.value)} />
                                </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                    <div className="avatar avatar-sm">{(user.email || '?').charAt(0).toUpperCase()}</div>
                                    <div>
                                        <p style={{ fontWeight: 600, fontSize: '0.85rem', lineHeight: 1.2 }}>{user.email ? user.email.split('@')[0] : '用戶'}</p>
                                        <p style={{ color: '#94A3B8', fontSize: '0.7rem' }}>{user.email || ''}</p>
                                    </div>
                                </div>
                                <button className="btn-secondary" style={{ padding: '0.4rem 0.75rem', fontSize: '0.8rem' }} onClick={logout}>登出</button>
                            </div>
                        </div>

                        <div className={`page-content ${currentView === 'pipeline' ? 'pipeline-full' : ''}`}>
                            {currentView === 'dashboard' && <Dashboard ctx={ctx} onNav={setCurrentView} />}
                            {currentView === 'customers' && <Customers ctx={ctx} />}
                            {currentView === 'pipeline' && <LeadSchedule ctx={ctx} />}
                            {currentView === 'voice' && !voiceLocked && <VoiceRecording ctx={ctx} />}
                            {currentView === 'voice' && voiceLocked && <VoiceRecording />}
                            {currentView === 'team' && <TeamManagement ctx={ctx} />}
                            {currentView === 'store' && <PluginStore />}
                            {currentView === 'wishes' && <WishPool ctx={ctx} />}
                        </div>
                    </div>

                    {completeContactModal && getCustomer(completeContactModal.customerId) && (
                        <CompleteContactModal
                            customer={getCustomer(completeContactModal.customerId)}
                            interactions={interactions.filter(i => i.customerId === completeContactModal.customerId)}
                            onConfirm={(data) => completeContact(completeContactModal.customerId, data)}
                            onClose={() => setCompleteContactModal(null)}
                        />
                    )}
                    {rescheduleModal && getCustomer(rescheduleModal.customerId) && (
                        <RescheduleModal
                            customer={getCustomer(rescheduleModal.customerId)}
                            onConfirm={(newDate) => rescheduleCustomer(rescheduleModal.customerId, newDate)}
                            onClose={() => setRescheduleModal(null)}
                        />
                    )}
                    {addScheduleModal && (
                        <AddScheduleModal
                            customers={customers}
                            prefilledCustomerId={addScheduleModal.customerId || null}
                            prefilledDate={addScheduleModal.prefilledDate || null}
                            onConfirm={(cid, data) => addSchedule(cid, data)}
                            onClose={() => setAddScheduleModal(null)}
                        />
                    )}
                </div>
            );
        }

        // ==================== DASHBOARD ====================
        function Dashboard({ ctx, onNav }) {
            const { customers, deals, interactions, setCustomerSort, setCustomerFocusFilter, toast, setCompleteContactModal } = ctx;

            // -- 時間邊界 --
            const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
            const startOfTomorrow = new Date(startOfToday); startOfTomorrow.setDate(startOfTomorrow.getDate() + 1);

            // -- 今日排程 --
            const todayCustomers = customers
                .filter(c => c.nextContact && c.nextContact >= startOfToday.getTime() && c.nextContact < startOfTomorrow.getTime())
                .sort((a, b) => a.nextContact - b.nextContact);

            // -- 逾期客戶 --
            const overdueCustomers = customers
                .filter(c => c.nextContact && c.nextContact < startOfToday.getTime())
                .sort((a, b) => a.nextContact - b.nextContact);

            // -- 今日進度 --
            const completedToday = customers.filter(c => {
                if (!c.lastContact) return false;
                return c.lastContact >= startOfToday.getTime() && c.lastContact < startOfTomorrow.getTime();
            }).length;
            const todayTotal = todayCustomers.length + completedToday;
            const progressPct = todayTotal > 0 ? (completedToday / todayTotal) * 100 : 0;

            // -- 既有統計 --
            const needFollowCustomers = customers.filter(c => (Date.now() - (c.lastContact || c.createdAt)) > 3 * day && c.status !== 'closed');
            const needFollow = needFollowCustomers.length;
            const weekEnd = new Date(); weekEnd.setDate(weekEnd.getDate() + 7);
            const weekDeals = deals.filter(d => d.stage !== 'closed' && d.expectedClose && d.expectedClose <= weekEnd.getTime()).length;

            // -- 新增業績指標 --
            const startOfWeek = new Date(startOfToday); startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const weekClosedValue = deals.filter(d => d.stage === 'closed').reduce((s, d) => s + (d.value || 0), 0);
            const todayNewCustomers = customers.filter(c => c.createdAt >= startOfToday.getTime() && c.createdAt < startOfTomorrow.getTime()).length;
            const myClosedDeals = deals.filter(d => d.stage === 'closed');
            const monthValue = myClosedDeals.reduce((s, d) => s + (d.value || 0), 0);
            const monthTarget = 300000;
            const targetPct = monthTarget > 0 ? (monthValue / monthTarget) * 100 : 0;
            const teamMemberCount = (ctx.team || []).length;
            const teamTotalValue = (ctx.team || []).reduce((s, m) => s + m.value, 0);

            const recentInter = [...interactions].sort((a, b) => b.createdAt - a.createdAt).slice(0, 5);
            const typeIcons = { call: '📞', email: '📧', meeting: '📅', note: '📝' };

            return (
                <div>
                    <div style={{ marginBottom: '1.5rem' }}>
                        <h2 className="page-title">智能工作台</h2>
                        <p className="page-subtitle">{new Date().toLocaleDateString('zh-TW', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>

                    {/* 統計卡片 — 2排4格 */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))', gap: '1rem', marginBottom: '1.5rem' }}>
                        {/* 今日排程進度 */}
                        <div className="stat-card" style={{ cursor: 'pointer' }} onClick={() => onNav('pipeline')} title="點擊查看排程">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem', position: 'relative', zIndex: 1 }}>
                                <span style={{ fontSize: '1.5rem' }}>📋</span>
                                <span style={{ color: '#64748B', fontSize: '0.7rem' }}>點擊查看 →</span>
                            </div>
                            <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginBottom: '0.25rem' }}>今日排程進度</p>
                            <p style={{ fontSize: '1.5rem', fontWeight: 700, color: progressPct >= 100 ? '#10B981' : '#F97316', marginBottom: '0.25rem' }}>
                                已完成 {completedToday} / 共 {todayTotal}
                            </p>
                            <div className="progress-bar-lg" style={{ marginTop: '0.25rem' }}>
                                <div className="progress-fill-lg" style={{ width: Math.min(progressPct, 100) + '%', background: progressPct >= 100 ? 'linear-gradient(90deg, #10B981, #34D399)' : 'linear-gradient(90deg, #F97316, #FB923C)' }}></div>
                            </div>
                        </div>

                        {/* 逾期未聯繫 */}
                        <div className="stat-card">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem', position: 'relative', zIndex: 1 }}>
                                <span style={{ fontSize: '1.5rem' }}>🔴</span>
                                <span style={{ color: '#64748B', fontSize: '0.7rem' }}>逾期名單</span>
                            </div>
                            <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginBottom: '0.25rem' }}>逾期未聯繫</p>
                            <p style={{ fontSize: '1.45rem', fontWeight: 700, color: overdueCustomers.length > 0 ? '#EF4444' : '#10B981' }}>{overdueCustomers.length} 位</p>
                            <button className="btn-secondary" style={{ marginTop: '0.5rem', padding: '0.3rem 0.65rem', fontSize: '0.75rem' }}
                                onClick={() => { setCustomerFocusFilter('overdue'); setCustomerSort('default'); onNav('customers'); }}>
                                查看名單 →
                            </button>
                        </div>

                        {/* 待跟進 */}
                        <div className="stat-card">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem', position: 'relative', zIndex: 1 }}>
                                <span style={{ fontSize: '1.5rem' }}>🟡</span>
                                <span style={{ color: '#64748B', fontSize: '0.7rem' }}>待跟進名單</span>
                            </div>
                            <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginBottom: '0.25rem' }}>待跟進</p>
                            <p style={{ fontSize: '1.45rem', fontWeight: 700, color: needFollow > 3 ? '#F59E0B' : '#CBD5E1' }}>{needFollow} 位</p>
                            <button className="btn-secondary" style={{ marginTop: '0.5rem', padding: '0.3rem 0.65rem', fontSize: '0.75rem' }}
                                onClick={() => { setCustomerFocusFilter('followup'); setCustomerSort('default'); onNav('customers'); }}>
                                查看名單 →
                            </button>
                        </div>

                        {/* 今日新增 */}
                        <div className="stat-card">
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem', position: 'relative', zIndex: 1 }}>
                                <span style={{ fontSize: '1.5rem' }}>✨</span>
                                <span style={{ color: '#64748B', fontSize: '0.7rem' }}>今日新增名單</span>
                            </div>
                            <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginBottom: '0.25rem' }}>今日新增</p>
                            <p style={{ fontSize: '1.45rem', fontWeight: 700, color: '#8B5CF6' }}>{todayNewCustomers} 位</p>
                            <button className="btn-secondary" style={{ marginTop: '0.5rem', padding: '0.3rem 0.65rem', fontSize: '0.75rem' }}
                                onClick={() => { setCustomerFocusFilter('newtoday'); setCustomerSort('newest'); onNav('customers'); }}>
                                查看名單 →
                            </button>
                        </div>

                        {/* 業績總覽（成交金額 + 目標達成率） */}
                        <div className="stat-card">
                            <div style={{ marginBottom: '0.75rem', position: 'relative', zIndex: 1 }}>
                                <span style={{ fontSize: '1.5rem' }}>💰</span>
                            </div>
                            <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginBottom: '0.5rem' }}>業績總覽</p>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.4rem' }}>
                                <span style={{ fontSize: '0.85rem', color: '#CBD5E1' }}>已成交金額</span>
                                <span style={{ fontWeight: 700, fontSize: '1.1rem', color: '#10B981' }}>${weekClosedValue.toLocaleString()}</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.25rem' }}>
                                <span style={{ fontSize: '0.85rem', color: '#CBD5E1' }}>目標達成率</span>
                                <span style={{ fontWeight: 700, fontSize: '1.1rem', color: targetPct >= 100 ? '#10B981' : targetPct >= 70 ? '#F59E0B' : '#EF4444' }}>{targetPct.toFixed(0)}%</span>
                            </div>
                            <div className="progress-bar-lg" style={{ marginTop: '0.25rem' }}>
                                <div className="progress-fill-lg" style={{ width: Math.min(targetPct, 100) + '%', background: targetPct >= 100 ? 'linear-gradient(90deg, #10B981, #34D399)' : targetPct >= 70 ? 'linear-gradient(90deg, #F59E0B, #FBBF24)' : 'linear-gradient(90deg, #EF4444, #F87171)' }}></div>
                            </div>
                            <p style={{ color: '#64748B', fontSize: '0.7rem', marginTop: '0.25rem' }}>${monthValue.toLocaleString()} / ${monthTarget.toLocaleString()}</p>
                        </div>

                        {/* 本週預計成交 */}
                        <div className="stat-card">
                            <div style={{ marginBottom: '0.75rem', position: 'relative', zIndex: 1 }}>
                                <span style={{ fontSize: '1.5rem' }}>🎯</span>
                            </div>
                            <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginBottom: '0.25rem' }}>本週預計成交</p>
                            <p style={{ fontSize: '1.5rem', fontWeight: 700, color: '#3B82F6' }}>{weekDeals} 筆</p>
                        </div>
                    </div>

                    {/* 逾期警示 */}
                    {overdueCustomers.length > 0 && (
                        <div className="card" style={{ borderColor: 'rgba(239,68,68,0.4)', marginBottom: '1.5rem' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem' }}>
                                <h3 style={{ fontWeight: 600, fontSize: '1.05rem', color: '#EF4444' }}>🔴 {overdueCustomers.length} 筆逾期未聯繫</h3>
                                <button className="btn-secondary" style={{ padding: '0.3rem 0.75rem', fontSize: '0.75rem' }} onClick={() => onNav('pipeline')}>查看全部 →</button>
                            </div>
                            {overdueCustomers.slice(0, 3).map(c => {
                                var od = getOverdueDays(c.nextContact);
                                var level = getOverdueLevel(od);
                                return (
                                    <div key={c.id} className={'overdue-' + level} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0.65rem 0.75rem', borderRadius: '8px', marginBottom: '0.4rem', background: 'rgba(30,41,59,0.4)' }}>
                                        <div>
                                            <span style={{ fontWeight: 600, fontSize: '0.9rem' }}>{c.name}</span>
                                            <span style={{ color: '#94A3B8', fontSize: '0.8rem', marginLeft: '0.75rem' }}>📞 {c.phone || '—'}</span>
                                            {c.plan && <span style={{ color: '#94A3B8', fontSize: '0.8rem', marginLeft: '0.75rem' }}>· {c.plan}</span>}
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                            <span style={{ color: level === 'critical' ? '#EF4444' : level === 'warning' ? '#F97316' : '#F59E0B', fontWeight: 600, fontSize: '0.8rem' }}>逾期 {od} 天</span>
                                            <button className="btn-complete" onClick={() => setCompleteContactModal({ customerId: c.id })}>✓ 完成聯繫</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* 今日排程 + 最近互動 */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(340px, 1fr))', gap: '1.5rem' }}>
                        <div className="card">
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.25rem' }}>
                                <h3 style={{ fontWeight: 600, fontSize: '1.1rem' }}>📋 今日排程 ({todayCustomers.length})</h3>
                                <button className="btn-secondary" style={{ padding: '0.3rem 0.75rem', fontSize: '0.75rem' }} onClick={() => onNav('pipeline')}>查看全部 →</button>
                            </div>
                            {todayCustomers.length === 0 ? (
                                <p style={{ color: '#94A3B8', fontSize: '0.875rem', textAlign: 'center', padding: '1rem' }}>今日暫無排程 ✓</p>
                            ) : todayCustomers.map(c => (
                                <div key={c.id} style={{ background: 'rgba(30,41,59,0.5)', padding: '0.85rem', borderRadius: '8px', marginBottom: '0.6rem' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.35rem' }}>
                                        <div>
                                            <span style={{ fontWeight: 600, fontSize: '0.95rem' }}>{c.name}</span>
                                            <span style={{ color: '#94A3B8', fontSize: '0.8rem', marginLeft: '0.5rem' }}>📞 {c.phone || '—'}</span>
                                        </div>
                                        <span className={`badge ${getStatusInfo(c.status).badge}`}>{getStatusInfo(c.status).label}</span>
                                    </div>
                                    {c.preference && <p style={{ color: '#CBD5E1', fontSize: '0.8rem', marginBottom: '0.25rem' }}>💬 偏好：{c.preference}</p>}
                                    {c.plan && <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginBottom: '0.5rem' }}>📝 {c.plan}</p>}
                                    <button className="btn-complete" onClick={() => setCompleteContactModal({ customerId: c.id })}>✓ 完成聯繫</button>
                                </div>
                            ))}
                        </div>

                        <div className="card">
                            <h3 style={{ fontWeight: 600, fontSize: '1.1rem', marginBottom: '1.25rem' }}>📞 最近互動</h3>
                            {recentInter.length === 0 ? (
                                <p style={{ color: '#94A3B8', fontSize: '0.875rem', textAlign: 'center', padding: '1rem' }}>尚無互動記錄</p>
                            ) : recentInter.map(inter => {
                                const cust = ctx.getCustomer(inter.customerId);
                                return (
                                    <div key={inter.id} style={{ display: 'flex', gap: '0.75rem', padding: '0.7rem', borderRadius: '8px', marginBottom: '0.4rem', background: 'rgba(30,41,59,0.3)' }}>
                                        <span style={{ fontSize: '1.25rem' }}>{typeIcons[inter.type] || '📝'}</span>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.15rem' }}>
                                                <p style={{ fontWeight: 600, fontSize: '0.875rem' }}>{cust ? cust.name : '未知'}</p>
                                                <span style={{ color: '#94A3B8', fontSize: '0.75rem', flexShrink: 0 }}>{fmtTime(inter.createdAt)}</span>
                                            </div>
                                            <p style={{ color: '#94A3B8', fontSize: '0.8rem', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>{inter.title || inter.content || '（無摘要）'}</p>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== CUSTOMERS ====================
        function Customers({ ctx }) {
            const { customers, interactions, deals, addCustomer, updateCustomer, deleteCustomer, addInteraction, globalSearch, customerSort, setCustomerSort, moveCustomer, customerFocusFilter, setCustomerFocusFilter } = ctx;
            const [search, setSearch] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [showAdd, setShowAdd] = useState(false);
            const [showQuickAdd, setShowQuickAdd] = useState(false);
            const [showImport, setShowImport] = useState(false);
            const [selectedId, setSelectedId] = useState(null);
            const [draggingId, setDraggingId] = useState(null);

            const q = (search || globalSearch).toLowerCase();
            const filtered = customers.filter(c => {
                const matchSearch = !q
                    || c.name.toLowerCase().includes(q)
                    || (c.phone || '').toLowerCase().includes(q)
                    || (c.email || '').toLowerCase().includes(q)
                    || (c.city || '').toLowerCase().includes(q)
                    || (c.source || '').toLowerCase().includes(q)
                    || (c.preference || '').toLowerCase().includes(q);
                const matchStatus = statusFilter === 'all' || c.status === statusFilter;
                return matchSearch && matchStatus;
            });

            const sortLabels = { 'follow-up': '待跟進優先', 'newest': '最新名單優先' };
            const sorted = customerSort !== 'default' ? [...filtered].sort((a, b) => {
                if (customerSort === 'follow-up') return (a.lastContact || a.createdAt) - (b.lastContact || b.createdAt);
                if (customerSort === 'newest') return b.createdAt - a.createdAt;
                return 0;
            }) : filtered;

            const selected = selectedId ? customers.find(c => c.id === selectedId) : null;
            const startOfToday = new Date(); startOfToday.setHours(0, 0, 0, 0);
            const startOfTomorrow = new Date(startOfToday); startOfTomorrow.setDate(startOfTomorrow.getDate() + 1);
            const isOverdue = (c) => !!c.nextContact && c.nextContact < startOfToday.getTime();
            const isFollowup = (c) => (Date.now() - (c.lastContact || c.createdAt)) > 3 * day && c.status !== 'closed';
            const isNewToday = (c) => c.createdAt >= startOfToday.getTime() && c.createdAt < startOfTomorrow.getTime();
            const matchFocus = (c) => {
                if (!customerFocusFilter) return false;
                if (customerFocusFilter === 'overdue') return isOverdue(c);
                if (customerFocusFilter === 'followup') return isFollowup(c);
                if (customerFocusFilter === 'newtoday') return isNewToday(c);
                return false;
            };
            const focusMeta = {
                overdue: { label: '逾期未聯繫', color: '#EF4444', bg: 'rgba(239,68,68,0.1)' },
                followup: { label: '待跟進', color: '#F59E0B', bg: 'rgba(245,158,11,0.1)' },
                newtoday: { label: '今日新增', color: '#8B5CF6', bg: 'rgba(139,92,246,0.12)' },
            };

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <div>
                            <h2 className="page-title">客戶管理</h2>
                            <p className="page-subtitle">共 {customers.length} 位客戶</p>
                        </div>
                        <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                            <button className="btn-primary" onClick={() => setShowQuickAdd(true)}>⚡ 快速新增</button>
                            <button className="btn-secondary" onClick={() => setShowAdd(true)}>＋ 完整新增</button>
                            <button className="btn-secondary" onClick={() => setShowImport(true)}>📥 匯入 CSV</button>
                        </div>
                    </div>

                    {customerSort !== 'default' && (
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: 'rgba(249,115,22,0.1)', border: '1px solid rgba(249,115,22,0.25)', borderRadius: '8px', padding: '0.5rem 1rem', marginBottom: '1rem', fontSize: '0.85rem' }}>
                            <span style={{ color: '#F97316' }}>排序中：{sortLabels[customerSort]}</span>
                            <button onClick={() => setCustomerSort('default')}
                                style={{ background: 'none', border: 'none', color: '#94A3B8', cursor: 'pointer', fontSize: '0.8rem', padding: '0.2rem 0.5rem' }}>✕ 清除排序</button>
                        </div>
                    )}
                    {customerFocusFilter && focusMeta[customerFocusFilter] && (
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: focusMeta[customerFocusFilter].bg, border: '1px solid ' + focusMeta[customerFocusFilter].color, borderRadius: '8px', padding: '0.5rem 1rem', marginBottom: '1rem', fontSize: '0.85rem' }}>
                            <span style={{ color: focusMeta[customerFocusFilter].color }}>已高亮：{focusMeta[customerFocusFilter].label}</span>
                            <button onClick={() => setCustomerFocusFilter(null)}
                                style={{ background: 'none', border: 'none', color: '#CBD5E1', cursor: 'pointer', fontSize: '0.8rem', padding: '0.2rem 0.5rem' }}>✕ 清除高亮</button>
                        </div>
                    )}

                    <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '1.5rem', flexWrap: 'wrap' }}>
                        <input type="text" placeholder="搜尋姓名、電話、Email、來源..." value={search} onChange={e => setSearch(e.target.value)}
                            style={{ maxWidth: 300 }} />
                        <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} style={{ width: 'auto', minWidth: 120 }}>
                            <option value="all">全部狀態</option>
                            {Object.entries(STATUS_MAP).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                        </select>
                    </div>

                    {sorted.length === 0 ? (
                        <div className="empty-state">
                            <p style={{ fontSize: '2.5rem', marginBottom: '0.75rem' }}>👥</p>
                            <p style={{ fontSize: '1.1rem', fontWeight: 600, marginBottom: '0.5rem' }}>尚無客戶</p>
                            <p style={{ fontSize: '0.875rem' }}>點擊「新增客戶」開始建立你的客戶資料庫</p>
                        </div>
                    ) : (
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '1rem' }}>
                            {sorted.map(c => (
                                (() => {
                                    var customerInteractions = interactions.filter(function(i) { return i.customerId === c.id; });
                                    var customerDeals = deals.filter(function(d) { return d.customerId === c.id; });
                                    var leadScore = getCustomerScore(c, customerInteractions, customerDeals);
                                    var scoreInfo = getScoreInfo(leadScore);
                                    var nextAction = getNextActionText(c, leadScore);
                                    var overdueDays = getOverdueDays(c.nextContact);
                                    var schemaList = c.customFieldSchema || [];
                                    var templateList = (ctx.customerFieldTemplate || []);
                                    var nameById = {};
                                    schemaList.forEach(function(f) { if (f && f.id) nameById[f.id] = f.name || ''; });
                                    templateList.forEach(function(f) { if (f && f.id && !nameById[f.id]) nameById[f.id] = f.name || ''; });
                                    var customValues = c.customValues || {};
                                    var usedIds = {};
                                    var customRows = schemaList.map(function(f) {
                                        var raw = customValues[f.id];
                                        var v = (raw === null || raw === undefined) ? '' : String(raw).trim();
                                        usedIds[f.id] = true;
                                        return ((f.name && String(f.name).trim()) ? f.name : '自訂欄位') + '：' + (v || '');
                                    }).filter(Boolean);
                                    Object.keys(customValues).forEach(function(id) {
                                        if (usedIds[id]) return;
                                        var raw = customValues[id];
                                        var v = (raw === null || raw === undefined) ? '' : String(raw).trim();
                                        if (!v) return;
                                        var label = (nameById[id] && String(nameById[id]).trim()) ? nameById[id] : '自訂欄位';
                                        customRows.push(label + '：' + v);
                                    });
                                    return (
                                <div
                                    key={c.id}
                                    className="card card-lift"
                                    style={{
                                        cursor: customerSort === 'default' ? 'grab' : 'pointer',
                                        border: draggingId === c.id
                                            ? '1px dashed rgba(249,115,22,0.6)'
                                            : matchFocus(c)
                                                ? (customerFocusFilter === 'overdue' ? '2px solid #EF4444' : customerFocusFilter === 'followup' ? '2px solid #F59E0B' : '2px solid #8B5CF6')
                                                : undefined,
                                        boxShadow: matchFocus(c) ? '0 0 0 2px rgba(255,255,255,0.04)' : undefined
                                    }}
                                    draggable={customerSort === 'default'}
                                    onDragStart={(e) => {
                                        if (customerSort !== 'default') return;
                                        e.dataTransfer.effectAllowed = 'move';
                                        setDraggingId(c.id);
                                    }}
                                    onDragOver={(e) => {
                                        if (customerSort !== 'default') return;
                                        e.preventDefault();
                                        e.dataTransfer.dropEffect = 'move';
                                    }}
                                    onDrop={(e) => {
                                        if (customerSort !== 'default') return;
                                        e.preventDefault();
                                        if (draggingId && draggingId !== c.id) moveCustomer(draggingId, c.id);
                                        setDraggingId(null);
                                    }}
                                    onDragEnd={() => setDraggingId(null)}
                                    onClick={() => setSelectedId(c.id)}
                                >
                                    <div style={{ display: 'flex', gap: '0.75rem', marginBottom: '0.75rem' }}>
                                        <div className="avatar">{c.name.charAt(0)}</div>
                                        <div style={{ flex: 1, minWidth: 0 }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                <div>
                                                    <p style={{ fontWeight: 700, fontSize: '1.05rem' }}>{c.name}</p>
                                                    <p style={{ color: '#94A3B8', fontSize: '0.825rem' }}>{c.phone || c.email || '—'}</p>
                                                </div>
                                                <span className={`badge ${getStatusInfo(c.status).badge}`}>
                                                    {getStatusInfo(c.status).label}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style={{ background: 'rgba(30,41,59,0.4)', padding: '0.75rem', borderRadius: '8px', fontSize: '0.825rem', color: '#CBD5E1' }}>
                                        {c.email && <p style={{ marginBottom: '0.25rem' }}>📧 {c.email}</p>}
                                        {c.phone && <p style={{ marginBottom: '0.25rem' }}>📞 {c.phone}</p>}
                                        {c.preference && <p style={{ marginBottom: '0.25rem' }}>💬 偏好聯絡：{c.preference}</p>}
                                        {customRows.map(function(row, idx) {
                                            return <p key={'custom-' + c.id + '-' + idx} style={{ marginBottom: '0.25rem' }}>🧩 {row}</p>;
                                        })}
                                        <p style={{ marginTop: '0.35rem', color: overdueDays > 0 ? '#EF4444' : '#94A3B8', fontSize: '0.8rem' }}>
                                            {c.nextContact ? `📅 安排日期：${formatWeekday(c.nextContact)}${overdueDays > 0 ? `（逾期 ${overdueDays} 天）` : ''}` : '📅 安排日期：尚未安排'}
                                        </p>
                                        <div style={{ marginTop: '0.45rem', display: 'flex', alignItems: 'center', gap: '0.45rem', flexWrap: 'wrap' }}>
                                            <span className="badge" style={{ background: scoreInfo.bg, color: scoreInfo.tone, border: scoreInfo.border }}>
                                                Lead Score {leadScore} · {scoreInfo.label}
                                            </span>
                                            <span style={{ color: '#CBD5E1', fontSize: '0.78rem' }}>👉 {nextAction}</span>
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '0.6rem' }}>
                                        <div style={{ display: 'flex', gap: '0.35rem', flexWrap: 'wrap' }}>
                                            {c.tags && c.tags.map(t => <span key={t} className="badge badge-primary" style={{ fontSize: '0.65rem' }}>{t}</span>)}
                                        </div>
                                        <div style={{ display: 'flex', gap: '0.35rem' }}>
                                            <button className="btn-secondary" style={{ padding: '0.2rem 0.6rem', fontSize: '0.7rem', whiteSpace: 'nowrap' }}
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    ctx.setCompleteContactModal({ customerId: c.id });
                                                }}>完成聯繫</button>
                                            <button className="btn-secondary" style={{ padding: '0.2rem 0.6rem', fontSize: '0.7rem', whiteSpace: 'nowrap' }}
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    setSelectedId(c.id);
                                                }}>筆記</button>
                                            <button className="btn-secondary" style={{ padding: '0.2rem 0.6rem', fontSize: '0.7rem', whiteSpace: 'nowrap' }}
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    ctx.setAddScheduleModal({ customerId: c.id });
                                                }}>排程 ▶</button>
                                        </div>
                                    </div>
                                </div>
                                    );
                                })()
                            ))}
                        </div>
                    )}

                    {showAdd && <CustomerModal ctx={ctx} onClose={() => setShowAdd(false)} onSave={(data) => { addCustomer(data); setShowAdd(false); }} />}
                    {showQuickAdd && <QuickAddModal onClose={() => setShowQuickAdd(false)} onSave={(data) => { addCustomer(data); setShowQuickAdd(false); }} />}
                    {showImport && <ImportCSVModal onClose={() => setShowImport(false)} onImport={(rows) => { rows.forEach(r => addCustomer(r)); setShowImport(false); }} />}
                    {selected && <CustomerDetail customer={selected} interactions={interactions.filter(i => i.customerId === selected.id)} deals={ctx.deals.filter(d => d.customerId === selected.id)}
                        onClose={() => setSelectedId(null)} onUpdate={(data) => updateCustomer(selected.id, data)}
                        onDelete={() => { deleteCustomer(selected.id); setSelectedId(null); }}
                        onAddInteraction={(data) => addInteraction({ ...data, customerId: selected.id })} ctx={ctx} />}
                </div>
            );
        }

        // ==================== CUSTOMER MODAL (ADD/EDIT) ====================
        function CustomerModal({ ctx, onClose, onSave, onAutoSave, initial }) {
            const templateFields = (initial && initial.customFieldSchema) || (ctx && ctx.customerFieldTemplate) || [];
            const [form, setForm] = useState(function() {
                var base = initial || {
                    name: '', preference: '', email: '', phone: '', status: 'new', plan: '', nextContact: null, tags: []
                };
                var schema = (base.customFieldSchema && base.customFieldSchema.length ? base.customFieldSchema : templateFields).map(function(f) {
                    return { id: f.id || genId(), name: f.name || '', type: f.type === 'select' ? 'select' : 'text', options: Array.isArray(f.options) ? f.options : [] };
                });
                var values = { ...(base.customValues || {}) };
                schema.forEach(function(f) {
                    if (values[f.id] === undefined) values[f.id] = '';
                });
                return { ...base, customFieldSchema: schema, customValues: values };
            });
            const [errors, setErrors] = useState({});
            const [tagInput, setTagInput] = useState('');
            const [newCustomName, setNewCustomName] = useState('');
            const [newCustomType, setNewCustomType] = useState('text');
            const [newCustomOptions, setNewCustomOptions] = useState('');
            const autoSaveTimerRef = useRef(null);
            const isFirstRenderRef = useRef(true);
            const set = (k, v) => setForm(prev => ({ ...prev, [k]: v }));
            const setCustomField = (id, patch) => setForm(prev => ({
                ...prev,
                customFieldSchema: prev.customFieldSchema.map(function(f) { return f.id === id ? { ...f, ...patch } : f; })
            }));
            const addCustomField = () => {
                var fid = genId();
                setForm(prev => ({
                    ...prev,
                    customFieldSchema: [...prev.customFieldSchema, { id: fid, name: '新欄位', type: 'text', options: [] }],
                    customValues: { ...prev.customValues, [fid]: '' }
                }));
            };
            const quickAddCustomField = () => {
                var name = (newCustomName || '').trim();
                if (!name) return;
                var fid = genId();
                var opts = newCustomType === 'select'
                    ? (newCustomOptions || '').split(',').map(function(x) { return x.trim(); }).filter(Boolean)
                    : [];
                setForm(prev => ({
                    ...prev,
                    customFieldSchema: [...prev.customFieldSchema, { id: fid, name: name, type: newCustomType, options: opts }],
                    customValues: { ...prev.customValues, [fid]: '' }
                }));
                setNewCustomName('');
                setNewCustomType('text');
                setNewCustomOptions('');
            };
            const removeCustomField = (id) => {
                setForm(prev => {
                    var vals = { ...prev.customValues };
                    delete vals[id];
                    return { ...prev, customFieldSchema: prev.customFieldSchema.filter(function(f) { return f.id !== id; }), customValues: vals };
                });
            };
            const setCustomValue = (id, value) => setForm(prev => ({ ...prev, customValues: { ...prev.customValues, [id]: value } }));
            const copyTemplate = () => {
                if (ctx && ctx.setCustomerFieldTemplate) {
                    ctx.setCustomerFieldTemplate(form.customFieldSchema);
                    if (ctx.toast) ctx.toast('欄位格式已複製，下次新增可沿用');
                }
            };
            const applyTemplate = () => {
                var tpl = (ctx && ctx.customerFieldTemplate) || [];
                var schema = tpl.map(function(f) { return { id: f.id || genId(), name: f.name || '', type: f.type === 'select' ? 'select' : 'text', options: Array.isArray(f.options) ? f.options : [] }; });
                var vals = {};
                schema.forEach(function(f) { vals[f.id] = ''; });
                setForm(prev => ({ ...prev, customFieldSchema: schema, customValues: vals }));
            };
            const handleSave = () => {
                const errs = {};
                if (!form.name.trim()) errs.name = '必填';
                if (Object.keys(errs).length) { setErrors(errs); return; }
                onSave({ ...form });
            };
            useEffect(() => {
                if (!initial || !onAutoSave) return;
                if (isFirstRenderRef.current) {
                    isFirstRenderRef.current = false;
                    return;
                }
                if (autoSaveTimerRef.current) clearTimeout(autoSaveTimerRef.current);
                autoSaveTimerRef.current = setTimeout(() => {
                    onAutoSave({ ...form });
                    if (ctx && ctx.toast) ctx.toast('已自動儲存');
                }, 450);
                return () => {
                    if (autoSaveTimerRef.current) clearTimeout(autoSaveTimerRef.current);
                };
            }, [form, initial, onAutoSave]);
            const addTag = () => {
                if (tagInput.trim() && !form.tags.includes(tagInput.trim())) {
                    set('tags', [...form.tags, tagInput.trim()]);
                    setTagInput('');
                }
            };
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" onClick={e => e.stopPropagation()}>
                        <h3 style={{ fontWeight: 700, fontSize: '1.2rem', marginBottom: '1.5rem' }}>{initial ? '編輯客戶' : '新增客戶'}</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>姓名 *</label>
                                <input value={form.name} onChange={e => set('name', e.target.value)} placeholder="客戶姓名"
                                    style={errors.name ? { borderColor: '#EF4444' } : {}} />
                                {errors.name && <p style={{ color: '#EF4444', fontSize: '0.75rem', marginTop: '0.25rem' }}>請填寫姓名</p>}
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>偏好聯絡</label>
                                <input value={form.preference} onChange={e => set('preference', e.target.value)} placeholder="例如：LINE/電話/Email" />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>Email</label>
                                    <input value={form.email} onChange={e => set('email', e.target.value)} placeholder="email@example.com" />
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>電話</label>
                                    <input value={form.phone} onChange={e => set('phone', e.target.value)} placeholder="電話號碼" />
                                </div>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>狀態</label>
                                    <select value={form.status} onChange={e => set('status', e.target.value)}>
                                        {Object.entries(STATUS_MAP).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>安排</label>
                                    <input value={form.plan || ''} onChange={e => set('plan', e.target.value)} placeholder="例如：安排試用 / 寄送優惠" />
                                </div>
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>安排日期</label>
                                <input
                                    type="datetime-local"
                                    value={toInputDateTime(form.nextContact)}
                                    onChange={e => set('nextContact', fromInputDateTime(e.target.value))}
                                />
                            </div>

                            {form.customFieldSchema.length > 0 && (
                                <div>
                                    <p style={{ fontSize: '0.85rem', color: '#94A3B8', marginBottom: '0.45rem' }}>自訂欄位內容</p>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.65rem' }}>
                                        {form.customFieldSchema.map(function(f) {
                                            var label = (f.name && String(f.name).trim()) ? f.name : '自訂欄位';
                                            return (
                                                <div key={'main-' + f.id}>
                                                    <label style={{ fontSize: '0.78rem', color: '#94A3B8', marginBottom: '0.2rem', display: 'block' }}>{label}</label>
                                                    {f.type === 'select' ? (
                                                        <select value={form.customValues[f.id] || ''} onChange={e => setCustomValue(f.id, e.target.value)}>
                                                            <option value="">未填寫</option>
                                                            {(f.options || []).map(function(op) { return <option key={op} value={op}>{op}</option>; })}
                                                        </select>
                                                    ) : (
                                                        <input value={form.customValues[f.id] || ''} onChange={e => setCustomValue(f.id, e.target.value)} placeholder={label} />
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            <div style={{ borderTop: '1px solid rgba(148,163,184,0.15)', paddingTop: '0.9rem' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.6rem', gap: '0.5rem', flexWrap: 'wrap' }}>
                                    <p style={{ fontSize: '0.9rem', fontWeight: 600 }}>自訂欄位</p>
                                    <div style={{ display: 'flex', gap: '0.45rem', flexWrap: 'wrap' }}>
                                        <button className="btn-secondary" style={{ padding: '0.25rem 0.55rem', fontSize: '0.75rem' }} onClick={applyTemplate}>套用預設格式</button>
                                        <button className="btn-secondary" style={{ padding: '0.25rem 0.55rem', fontSize: '0.75rem' }} onClick={copyTemplate}>複製欄位格式</button>
                                    </div>
                                </div>

                                <div style={{ background: 'rgba(30,41,59,0.35)', border: '1px dashed rgba(148,163,184,0.28)', borderRadius: '8px', padding: '0.6rem', marginBottom: '0.6rem' }}>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1.2fr 0.8fr auto', gap: '0.45rem', alignItems: 'center' }}>
                                        <input value={newCustomName} onChange={e => setNewCustomName(e.target.value)} placeholder="輸入新欄位名稱" />
                                        <select value={newCustomType} onChange={e => setNewCustomType(e.target.value)}>
                                            <option value="text">文字輸入</option>
                                            <option value="select">下拉選單</option>
                                        </select>
                                        <button className="btn-secondary" style={{ padding: '0.3rem 0.65rem', fontSize: '0.75rem' }} onClick={quickAddCustomField}>加入</button>
                                    </div>
                                    {newCustomType === 'select' && (
                                        <div style={{ marginTop: '0.45rem' }}>
                                            <input value={newCustomOptions} onChange={e => setNewCustomOptions(e.target.value)}
                                                placeholder="下拉選項（逗號分隔），例如：高,中,低" />
                                        </div>
                                    )}
                                </div>

                                {form.customFieldSchema.map(function(f) {
                                    return (
                                        <div key={f.id} style={{ background: 'rgba(30,41,59,0.45)', border: '1px solid rgba(148,163,184,0.18)', borderRadius: '8px', padding: '0.6rem', marginBottom: '0.45rem' }}>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1.2fr 0.8fr auto', gap: '0.45rem', alignItems: 'center' }}>
                                                <input value={f.name} onChange={e => setCustomField(f.id, { name: e.target.value })} placeholder="欄位名稱" />
                                                <select value={f.type} onChange={e => setCustomField(f.id, { type: e.target.value })}>
                                                    <option value="text">文字輸入</option>
                                                    <option value="select">下拉選單</option>
                                                </select>
                                                <button className="btn-danger" style={{ padding: '0.25rem 0.5rem', fontSize: '0.72rem' }} onClick={() => removeCustomField(f.id)}>刪除</button>
                                            </div>
                                            {f.type === 'select' && (
                                                <div style={{ marginTop: '0.45rem' }}>
                                                    <input value={(f.options || []).join(',')} onChange={e => setCustomField(f.id, { options: e.target.value.split(',').map(function(x) { return x.trim(); }).filter(Boolean) })}
                                                        placeholder="選項請用逗號分隔，例如：高,中,低" />
                                                </div>
                                            )}
                                            <div style={{ marginTop: '0.45rem' }}>
                                                <label style={{ fontSize: '0.72rem', color: '#94A3B8', display: 'block', marginBottom: '0.2rem' }}>欄位值</label>
                                                {f.type === 'select' ? (
                                                    <select value={form.customValues[f.id] || ''} onChange={e => setCustomValue(f.id, e.target.value)}>
                                                        <option value="">未填寫</option>
                                                        {(f.options || []).map(function(op) { return <option key={op} value={op}>{op}</option>; })}
                                                    </select>
                                                ) : (
                                                    <input value={form.customValues[f.id] || ''} onChange={e => setCustomValue(f.id, e.target.value)} placeholder="輸入內容" />
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>標籤</label>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    <input value={tagInput} onChange={e => setTagInput(e.target.value)} placeholder="輸入標籤後按 Enter"
                                        onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addTag())} style={{ flex: 1 }} />
                                    <button className="btn-secondary" onClick={addTag} style={{ padding: '0.5rem 1rem', whiteSpace: 'nowrap' }}>加入</button>
                                </div>
                                {form.tags.length > 0 && (
                                    <div style={{ display: 'flex', gap: '0.35rem', marginTop: '0.5rem', flexWrap: 'wrap' }}>
                                        {form.tags.map(t => (
                                            <span key={t} className="badge badge-primary" style={{ cursor: 'pointer' }}
                                                onClick={() => set('tags', form.tags.filter(x => x !== t))}>{t} ✕</span>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', marginTop: '1.5rem' }}>
                            {initial ? (
                                <button className="btn-primary" onClick={onClose}>完成</button>
                            ) : (
                                <>
                                    <button className="btn-secondary" onClick={onClose}>取消</button>
                                    <button className="btn-primary" onClick={handleSave}>新增</button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== QUICK ADD MODAL ====================
        function QuickAddModal({ onClose, onSave }) {
            const [name, setName] = useState('');
            const [phone, setPhone] = useState('');
            const [source, setSource] = useState('');
            const [error, setError] = useState('');
            var handleSave = () => {
                if (!name.trim()) { setError('請填寫姓名'); return; }
                onSave({ name: name.trim(), phone: phone.trim(), source: source.trim(), gender: '', ageRange: '', city: '', preference: '', email: '', status: 'new', plan: '', tags: [] });
            };
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" style={{ maxWidth: 400 }} onClick={e => e.stopPropagation()}>
                        <h3 style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: '1.25rem' }}>⚡ 快速新增客戶</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>姓名 *</label>
                                <input value={name} onChange={e => { setName(e.target.value); setError(''); }} placeholder="客戶姓名" style={error ? { borderColor: '#EF4444' } : {}} autoFocus />
                                {error && <p style={{ color: '#EF4444', fontSize: '0.75rem', marginTop: '0.25rem' }}>{error}</p>}
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>電話</label>
                                <input value={phone} onChange={e => setPhone(e.target.value)} placeholder="電話號碼" />
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>名單來源（選填）</label>
                                <input value={source} onChange={e => setSource(e.target.value)} placeholder="例如：Instagram / 門市" onKeyDown={e => e.key === 'Enter' && handleSave()} />
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', marginTop: '1.25rem' }}>
                            <button className="btn-secondary" onClick={onClose}>取消</button>
                            <button className="btn-primary" onClick={handleSave}>快速新增</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== IMPORT CSV MODAL ====================
        function parseCSV(text) {
            var lines = text.trim().split('`n');
            if (lines.length < 2) return [];
            var headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
            var nameIdx = headers.indexOf('name');
            if (nameIdx < 0) nameIdx = headers.indexOf('姓名');
            if (nameIdx < 0) return [];
            var fieldMap = { 'name': 'name', '姓名': 'name', 'phone': 'phone', '電話': 'phone', 'email': 'email', '信箱': 'email', 'city': 'city', '城市': 'city', 'source': 'source', '來源': 'source', 'preference': 'preference', '偏好': 'preference', 'tags': 'tags', '標籤': 'tags' };
            var rows = [];
            for (var i = 1; i < lines.length; i++) {
                var cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                if (!cols[nameIdx] || !cols[nameIdx].trim()) continue;
                var row = { name: '', phone: '', email: '', city: '', source: '', preference: '', gender: '', ageRange: '', status: 'new', plan: '', tags: [] };
                headers.forEach(function(h, idx) {
                    var field = fieldMap[h];
                    if (field && cols[idx]) {
                        if (field === 'tags') { row.tags = cols[idx].split(/[;；|]/).map(t => t.trim()).filter(Boolean); }
                        else { row[field] = cols[idx].trim(); }
                    }
                });
                rows.push(row);
            }
            return rows;
        }

        function ImportCSVModal({ onClose, onImport }) {
            const [rows, setRows] = useState(null);
            const [error, setError] = useState('');
            const [fileName, setFileName] = useState('');

            var handleFile = (e) => {
                var file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);
                var reader = new FileReader();
                reader.onload = function(ev) {
                    var parsed = parseCSV(ev.target.result);
                    if (parsed.length === 0) { setError('無法解析 CSV，請確認包含 name 或 姓名 欄位'); setRows(null); return; }
                    setRows(parsed);
                    setError('');
                };
                reader.readAsText(file);
            };

            var sampleCSV = 'name,phone,email,city,source,tags`n王小明,0912-345-678,wang@example.com,台北,Instagram,VIP;美妝`n李小華,0922-111-222,li@example.com,新北,門市,家電';
            var downloadSample = () => {
                var blob = new Blob(['\uFEFF' + sampleCSV], { type: 'text/csv;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url; a.download = 'smartcrm_sample.csv'; a.click();
                URL.revokeObjectURL(url);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" style={{ maxWidth: 560 }} onClick={e => e.stopPropagation()}>
                        <h3 style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: '1rem' }}>📥 匯入 CSV</h3>

                        <div style={{ background: 'rgba(30,41,59,0.4)', padding: '0.75rem', borderRadius: '8px', marginBottom: '1rem', fontSize: '0.8rem', color: '#94A3B8' }}>
                            <p style={{ marginBottom: '0.35rem' }}>CSV 欄位對應：<span style={{ color: '#F97316' }}>name/姓名（必填）</span>、phone/電話、email/信箱、city/城市、source/來源、preference/偏好、tags/標籤</p>
                            <p>標籤欄位可用 <code>;</code> 或 <code>|</code> 分隔多個標籤</p>
                            <button className="btn-secondary" style={{ padding: '0.25rem 0.6rem', fontSize: '0.7rem', marginTop: '0.5rem' }} onClick={downloadSample}>📄 下載範例 CSV</button>
                        </div>

                        <div style={{ marginBottom: '1rem' }}>
                            <input type="file" accept=".csv" onChange={handleFile} style={{ fontSize: '0.85rem' }} />
                        </div>

                        {error && <p style={{ color: '#EF4444', fontSize: '0.85rem', marginBottom: '0.75rem' }}>{error}</p>}

                        {rows && rows.length > 0 && (
                            <div>
                                <p style={{ fontWeight: 600, fontSize: '0.9rem', marginBottom: '0.5rem', color: '#10B981' }}>已解析 {rows.length} 筆資料，預覽前 5 筆：</p>
                                <div style={{ maxHeight: 200, overflowY: 'auto', marginBottom: '1rem' }}>
                                    {rows.slice(0, 5).map((r, i) => (
                                        <div key={i} style={{ background: 'rgba(30,41,59,0.3)', padding: '0.5rem 0.75rem', borderRadius: '6px', marginBottom: '0.35rem', fontSize: '0.825rem' }}>
                                            <span style={{ fontWeight: 600 }}>{r.name}</span>
                                            {r.phone && <span style={{ color: '#94A3B8', marginLeft: '0.5rem' }}>📞 {r.phone}</span>}
                                            {r.email && <span style={{ color: '#94A3B8', marginLeft: '0.5rem' }}>📧 {r.email}</span>}
                                            {r.city && <span style={{ color: '#94A3B8', marginLeft: '0.5rem' }}>🏙️ {r.city}</span>}
                                        </div>
                                    ))}
                                    {rows.length > 5 && <p style={{ color: '#94A3B8', fontSize: '0.8rem', textAlign: 'center' }}>...及其他 {rows.length - 5} 筆</p>}
                                </div>
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>
                            <button className="btn-secondary" onClick={onClose}>取消</button>
                            <button className="btn-primary" disabled={!rows || rows.length === 0} onClick={() => rows && onImport(rows)}
                                style={!rows || rows.length === 0 ? { opacity: 0.5, cursor: 'not-allowed' } : {}}>確認匯入 {rows ? rows.length : 0} 筆</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== CUSTOMER DETAIL PANEL ====================
        function CustomerDetail({ customer, interactions, deals, onClose, onUpdate, onDelete, onAddInteraction, ctx }) {
            const [editing, setEditing] = useState(false);
            const [noteType, setNoteType] = useState('note');
            const [noteTitle, setNoteTitle] = useState('');
            const [confirmDelete, setConfirmDelete] = useState(false);
            const [showAllTimeline, setShowAllTimeline] = useState(false);
            const [viewingNote, setViewingNote] = useState(null);
            const [manualNextContact, setManualNextContact] = useState(toInputDateTime(customer.nextContact));
            const typeIcons = { call: '📞', email: '📧', meeting: '📅', note: '📝' };
            const sorted = [...interactions].sort((a, b) => b.createdAt - a.createdAt);
            const timelineItems = showAllTimeline ? sorted : sorted.slice(0, 5);
            const genderLabel = customer.gender === 'male' ? '男' : customer.gender === 'female' ? '女' : customer.gender === 'other' ? '其他' : '未填';
            useEffect(() => {
                setManualNextContact(toInputDateTime(customer.nextContact));
            }, [customer.id, customer.nextContact]);

            const handleAddNote = () => {
                if (!noteTitle.trim()) return;
                var newInter = onAddInteraction({ type: noteType, title: noteTitle.trim(), content: '' });
                setNoteTitle('');
                if (newInter) setViewingNote(newInter.id);
            };

            if (editing) return <CustomerModal ctx={ctx} initial={customer} onClose={() => setEditing(false)} onSave={(data) => { onUpdate(data); setEditing(false); }} onAutoSave={(data) => onUpdate(data)} />;

            // -- NoteEditorPage 大筆記頁面 --
            if (viewingNote) {
                var note = interactions.find(i => i.id === viewingNote);
                if (!note) { setViewingNote(null); return null; }
                return <NoteEditorPage note={note} customerName={customer.name}
                    onBack={() => setViewingNote(null)}
                    onSave={(data) => ctx.updateInteraction(note.id, data)}
                    onDelete={() => { ctx.deleteInteraction(note.id); setViewingNote(null); }} />;
            }

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" style={{ maxWidth: 620 }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.25rem' }}>
                            <h3 style={{ fontWeight: 700, fontSize: '1.15rem' }}>客戶詳情</h3>
                            <button onClick={onClose} style={{ background: 'none', border: 'none', color: '#94A3B8', fontSize: '1.5rem', cursor: 'pointer' }}>✕</button>
                        </div>

                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '1rem' }}>
                            <div className="avatar" style={{ width: 56, height: 56, fontSize: '1.5rem' }}>{customer.name.charAt(0)}</div>
                            <div style={{ flex: 1 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', flexWrap: 'wrap' }}>
                                    <p style={{ fontWeight: 700, fontSize: '1.2rem' }}>{customer.name}</p>
                                    <span className={`badge ${getStatusInfo(customer.status).badge}`}>{getStatusInfo(customer.status).label}</span>
                                </div>
                                <p style={{ color: '#94A3B8', fontSize: '0.9rem' }}>{customer.phone || '—'}</p>
                            </div>
                        </div>

                        <div style={{ background: 'rgba(30,41,59,0.4)', padding: '1rem', borderRadius: '10px', marginBottom: '1rem', fontSize: '0.85rem' }}>
                            {(() => {
                                const budgetLabel = customer.budget === '0-5' ? '$0-5萬'
                                    : customer.budget === '5-20' ? '$5-20萬'
                                    : customer.budget === '20-50' ? '$20-50萬'
                                    : customer.budget === '50+' ? '$50萬+'
                                    : '';
                                const priorityLabel = customer.priority === 'high' ? '🔴 高'
                                    : customer.priority === 'mid' ? '🟡 中'
                                    : customer.priority === 'low' ? '🟢 低'
                                    : '';
                                const basicRows = [
                                    customer.email ? '📧 ' + customer.email : '',
                                    customer.phone ? '📞 ' + customer.phone : '',
                                    customer.preference ? '💬 偏好：' + customer.preference : '',
                                    (customer.gender || customer.ageRange) ? ('🧍 ' + [customer.gender ? genderLabel : '', customer.ageRange || ''].filter(Boolean).join(' · ')) : '',
                                    priorityLabel ? '🔔 優先級：' + priorityLabel : '',
                                    budgetLabel ? '💰 預算：' + budgetLabel : '',
                                    (customer.city || customer.source) ? ('🏙️ ' + [customer.city || '', customer.source || ''].filter(Boolean).join(' · ')) : '',
                                    customer.createdAt ? '📅 建立：' + fmtDate(customer.createdAt) : '',
                                    customer.lastContact ? '⏰ 最後聯繫：' + fmtTime(customer.lastContact) : '',
                                    customer.nextContact ? '📆 安排日期：' + toInputDateTime(customer.nextContact).replace('T', ' ') : '📆 安排日期：尚未安排',
                                ].filter(Boolean);
                                const schemaList = (customer.customFieldSchema || []);
                                const templateList = (ctx && ctx.customerFieldTemplate) ? ctx.customerFieldTemplate : [];
                                const nameById = {};
                                schemaList.forEach(function(f) { if (f && f.id) nameById[f.id] = f.name || ''; });
                                templateList.forEach(function(f) { if (f && f.id && !nameById[f.id]) nameById[f.id] = f.name || ''; });

                                const customValues = customer.customValues || {};
                                const usedIds = {};
                                const customRowsFromSchema = schemaList
                                    .map(function(f) {
                                        const raw = customValues[f.id];
                                        const v = (raw === null || raw === undefined) ? '' : String(raw).trim();
                                        usedIds[f.id] = true;
                                        return ((f.name && String(f.name).trim()) ? f.name : '自訂欄位') + '：' + (v || '');
                                    })
                                    .filter(Boolean);
                                const customRowsFromValues = Object.keys(customValues)
                                    .map(function(id) {
                                        if (usedIds[id]) return '';
                                        const raw = customValues[id];
                                        const v = (raw === null || raw === undefined) ? '' : String(raw).trim();
                                        if (!v) return '';
                                        const label = (nameById[id] && String(nameById[id]).trim()) ? nameById[id] : '自訂欄位';
                                        return label + '：' + v;
                                    })
                                    .filter(Boolean);
                                const customRows = customRowsFromSchema.concat(customRowsFromValues);
                                const allRows = basicRows.concat(customRows);
                                return allRows.length === 0 ? (
                                    <p style={{ color: '#94A3B8' }}>尚未填寫詳細資料</p>
                                ) : (
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.4rem 1rem' }}>
                                        {allRows.map((row, idx) => <div key={idx}>{row}</div>)}
                                    </div>
                                );
                            })()}
                        </div>

                        {customer.tags && customer.tags.length > 0 && (
                            <div style={{ display: 'flex', gap: '0.35rem', marginBottom: '1rem', flexWrap: 'wrap' }}>
                                {customer.tags.map(t => <span key={t} className="badge badge-primary">{t}</span>)}
                            </div>
                        )}

                        {deals.length > 0 && (
                            <div style={{ marginBottom: '1rem' }}>
                                <h4 style={{ fontWeight: 600, fontSize: '0.9rem', marginBottom: '0.5rem' }}>相關交易</h4>
                                {deals.map(d => (
                                    <div key={d.id} style={{ background: 'rgba(30,41,59,0.3)', padding: '0.6rem', borderRadius: '6px', marginBottom: '0.4rem', fontSize: '0.825rem' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                            <span style={{ fontWeight: 600 }}>{d.title}</span>
                                            <span style={{ color: '#F97316', fontWeight: 600 }}>${d.value.toLocaleString()}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.25rem', flexWrap: 'wrap' }}>
                            <button className="btn-complete" onClick={() => ctx.setCompleteContactModal({ customerId: customer.id })}>✓ 完成聯繫</button>
                            <button className="btn-secondary" onClick={() => setEditing(true)}>編輯</button>
                            <button className="btn-secondary" onClick={() => { ctx.setAddScheduleModal({ customerId: customer.id }); }}>排程 ▶</button>
                            {!confirmDelete ? (
                                <button className="btn-danger" onClick={() => setConfirmDelete(true)}>刪除</button>
                            ) : (
                                <button className="btn-danger" style={{ background: 'rgba(239,68,68,0.3)' }} onClick={onDelete}>確認刪除</button>
                            )}
                        </div>
                        <div style={{ marginBottom: '1rem' }}>
                            <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>安排日期（直接修改）</label>
                            <div style={{ display: 'flex', gap: '0.5rem' }}>
                                <input
                                    type="datetime-local"
                                    value={manualNextContact}
                                    onChange={e => setManualNextContact(e.target.value)}
                                    style={{ flex: 1 }}
                                />
                                <button
                                    className="btn-secondary"
                                    onClick={() => {
                                        onUpdate({ nextContact: fromInputDateTime(manualNextContact) });
                                        if (ctx && ctx.toast) ctx.toast('安排日期已更新');
                                    }}
                                    style={{ whiteSpace: 'nowrap' }}
                                >
                                    更新日期
                                </button>
                            </div>
                        </div>

                        <div style={{ borderTop: '1px solid rgba(148,163,184,0.1)', paddingTop: '1rem' }}>
                            <h4 style={{ fontWeight: 600, fontSize: '0.95rem', marginBottom: '1rem' }}>筆記</h4>

                            <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                                <select value={noteType} onChange={e => setNoteType(e.target.value)} className="note-type-select" style={{ width: 'auto', minWidth: 90 }}>
                                    <option value="note">📝 筆記</option>
                                    <option value="call">📞 通話</option>
                                    <option value="email">📧 郵件</option>
                                    <option value="meeting">📅 會面</option>
                                </select>
                                <input value={noteTitle} onChange={e => setNoteTitle(e.target.value)} placeholder="輸入筆記標題..."
                                    onKeyDown={e => e.key === 'Enter' && handleAddNote()} style={{ flex: 1 }} />
                                <button className="btn-primary" style={{ padding: '0.5rem 1rem', whiteSpace: 'nowrap' }} onClick={handleAddNote}>＋ 新增</button>
                            </div>

                            {sorted.length === 0 ? (
                                <p style={{ color: '#94A3B8', fontSize: '0.85rem', textAlign: 'center', padding: '1rem' }}>尚無筆記記錄</p>
                            ) : timelineItems.map(inter => (
                                <div key={inter.id} className="note-row" onClick={() => setViewingNote(inter.id)}>
                                    <select className="note-type-select" value={inter.type}
                                        onClick={e => e.stopPropagation()}
                                        onChange={e => { e.stopPropagation(); ctx.updateInteraction(inter.id, { type: e.target.value }); }}>
                                        <option value="note">📝</option>
                                        <option value="call">📞</option>
                                        <option value="email">📧</option>
                                        <option value="meeting">📅</option>
                                    </select>
                                    <span className="note-title">{inter.title || inter.content || '（無標題）'}</span>
                                    <span className="note-time">{fmtTime(inter.createdAt)}</span>
                                    <span className="note-arrow">→</span>
                                </div>
                            ))}

                            {sorted.length > 5 && !showAllTimeline && (
                                <button className="btn-secondary" style={{ marginTop: '0.5rem' }} onClick={() => setShowAllTimeline(true)}>
                                    顯示更多 (共 {sorted.length} 筆)
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== NOTE EDITOR PAGE ====================
        function NoteEditorPage({ note, customerName, onBack, onSave, onDelete }) {
            const [title, setTitle] = useState(note.title || '');
            const [content, setContent] = useState(note.content || '');
            const [confirmDel, setConfirmDel] = useState(false);
            const typeIcons = { call: '📞', email: '📧', meeting: '📅', note: '📝' };
            const typeLabels = { call: '通話', email: '郵件', meeting: '會面', note: '筆記' };

            var handleSave = () => {
                onSave({ title: title.trim() || '（無標題）', content: content });
                onBack();
            };

            return (
                <div className="modal-overlay" onClick={onBack}>
                    <div className="modal-box" style={{ maxWidth: 680, minHeight: 450 }} onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1.25rem' }}>
                            <button onClick={onBack} style={{ background: 'none', border: 'none', color: '#F97316', cursor: 'pointer', fontSize: '1rem', fontWeight: 600 }}>← 返回</button>
                            <span style={{ flex: 1, fontWeight: 700, fontSize: '1rem' }}>{customerName} 的筆記</span>
                            <span style={{ fontSize: '0.85rem', color: '#94A3B8' }}>{typeIcons[note.type]} {typeLabels[note.type]}</span>
                            <span style={{ fontSize: '0.75rem', color: '#64748B' }}>{fmtTime(note.createdAt)}</span>
                        </div>

                        <div style={{ marginBottom: '1rem' }}>
                            <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.3rem' }}>標題</label>
                            <input value={title} onChange={e => setTitle(e.target.value)}
                                style={{ width: '100%', fontSize: '1.1rem', fontWeight: 600 }} placeholder="筆記標題..." />
                        </div>

                        <div style={{ marginBottom: '1.5rem' }}>
                            <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.3rem' }}>詳細內容</label>
                            <textarea value={content} onChange={e => setContent(e.target.value)}
                                rows={12} placeholder="在此輸入詳細內容，可以寫上百字、記錄會面細節、客戶反應、下一步計劃..."
                                style={{ width: '100%', minHeight: '300px', resize: 'vertical', lineHeight: 1.7 }} />
                        </div>

                        <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <div>
                                {!confirmDel ? (
                                    <button className="btn-danger" onClick={() => setConfirmDel(true)}>刪除筆記</button>
                                ) : (
                                    <button className="btn-danger" style={{ background: 'rgba(239,68,68,0.3)' }} onClick={onDelete}>確認刪除</button>
                                )}
                            </div>
                            <button className="btn-primary" style={{ padding: '0.6rem 1.5rem', fontSize: '0.95rem' }} onClick={handleSave}>儲存</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== LEAD SCHEDULE ====================
        function LeadSchedule({ ctx }) {
            const { customers, addSchedule, removeSchedule, toast } = ctx;
            const [calMonth, setCalMonth] = useState(() => { var d = new Date(); return { year: d.getFullYear(), month: d.getMonth() }; });
            const [selectedDate, setSelectedDate] = useState(null);
            const [form, setForm] = useState({ customerId: '', hour: '08', minute: '00', activity: '', note: '' });

            var keyOf = function(ts) {
                var d = new Date(ts);
                return d.getFullYear() + '-' + d.getMonth() + '-' + d.getDate();
            };
            var startOf = function(ts) {
                var d = new Date(ts);
                d.setHours(0, 0, 0, 0);
                return d.getTime();
            };

            var scheduleByDate = {};
            customers.forEach(function(c) {
                if (!c.nextContact) return;
                var key = keyOf(c.nextContact);
                if (!scheduleByDate[key]) scheduleByDate[key] = [];
                scheduleByDate[key].push(c);
            });
            Object.keys(scheduleByDate).forEach(function(k) {
                scheduleByDate[k].sort(function(a, b) { return a.nextContact - b.nextContact; });
            });

            var today = new Date(); today.setHours(0, 0, 0, 0);
            var firstDay = new Date(calMonth.year, calMonth.month, 1);
            var lastDay = new Date(calMonth.year, calMonth.month + 1, 0);
            var startWeekday = firstDay.getDay();
            var cells = [];

            for (var p = startWeekday - 1; p >= 0; p--) {
                var pd = new Date(calMonth.year, calMonth.month, -p);
                pd.setHours(0, 0, 0, 0);
                cells.push({ ts: pd.getTime(), day: pd.getDate(), otherMonth: true });
            }
            for (var d = 1; d <= lastDay.getDate(); d++) {
                var cd = new Date(calMonth.year, calMonth.month, d);
                cd.setHours(0, 0, 0, 0);
                cells.push({ ts: cd.getTime(), day: d, otherMonth: false });
            }
            while (cells.length % 7 !== 0 || cells.length < 35) {
                var ni = cells.length - (startWeekday + lastDay.getDate()) + 1;
                var nd = new Date(calMonth.year, calMonth.month + 1, ni);
                nd.setHours(0, 0, 0, 0);
                cells.push({ ts: nd.getTime(), day: nd.getDate(), otherMonth: true });
            }

            var prevMonth = () => setCalMonth(prev => prev.month === 0 ? { year: prev.year - 1, month: 11 } : { year: prev.year, month: prev.month - 1 });
            var nextMonth = () => setCalMonth(prev => prev.month === 11 ? { year: prev.year + 1, month: 0 } : { year: prev.year, month: prev.month + 1 });
            var goToday = () => { var t = new Date(); t.setHours(0, 0, 0, 0); setCalMonth({ year: t.getFullYear(), month: t.getMonth() }); };

            var openDateEditor = function(ts) {
                setSelectedDate(startOf(ts));
                var now = new Date();
                setForm(prev => ({
                    ...prev,
                    hour: (now.getHours() + '').padStart(2, '0'),
                    minute: '00',
                    activity: '',
                    note: ''
                }));
            };

            if (selectedDate !== null) {
                var dLabel = (() => {
                    var sd = new Date(selectedDate);
                    var weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                    return sd.getFullYear() + '年' + (sd.getMonth() + 1) + '月' + sd.getDate() + '日（週' + weekdays[sd.getDay()] + '）';
                })();
                var dayKey = keyOf(selectedDate);
                var dayEvents = scheduleByDate[dayKey] || [];

                var addForDay = function() {
                    if (!form.customerId) { toast('請先選擇客戶'); return; }
                    if (!form.activity.trim()) { toast('請輸入排程內容'); return; }
                    var hh = Math.max(0, Math.min(23, Number(form.hour) || 0));
                    var mm = Math.max(0, Math.min(59, Number(form.minute) || 0));
                    var dt = new Date(selectedDate);
                    dt.setHours(hh, mm, 0, 0);
                    addSchedule(form.customerId, { date: dt.getTime(), title: form.activity.trim(), note: form.note.trim() });
                    setForm(prev => ({ ...prev, activity: '', note: '' }));
                };

                return (
                    <div className="day-editor-shell">
                        <div className="day-editor-card">
                            <div style={{ display: 'flex', justifyContent: 'space-between', gap: '0.75rem', alignItems: 'center', flexWrap: 'wrap' }}>
                                <div>
                                    <h2 className="page-title" style={{ marginBottom: '0.2rem', fontSize: '1.35rem' }}>空白排程頁</h2>
                                    <p className="page-subtitle">{dLabel} | 在這裡直接新增與刪除排程</p>
                                </div>
                                <button className="btn-secondary" onClick={() => setSelectedDate(null)}>← 回月曆</button>
                            </div>

                            <div className="day-editor-form" style={{ marginTop: '0.85rem' }}>
                                <div>
                                    <label style={{ fontSize: '0.78rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>客戶</label>
                                    <select value={form.customerId} onChange={e => setForm(prev => ({ ...prev, customerId: e.target.value }))}>
                                        <option value="">請選擇客戶</option>
                                        {customers.map(c => <option key={c.id} value={c.id}>{c.name}{c.phone ? ' (' + c.phone + ')' : ''}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.78rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>時</label>
                                    <input type="number" min="0" max="23" value={form.hour} onChange={e => setForm(prev => ({ ...prev, hour: e.target.value }))} />
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.78rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>分</label>
                                    <input type="number" min="0" max="59" value={form.minute} onChange={e => setForm(prev => ({ ...prev, minute: e.target.value }))} />
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.78rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>排程內容</label>
                                    <input value={form.activity} onChange={e => setForm(prev => ({ ...prev, activity: e.target.value }))} placeholder="例如：電話跟進 / 簽約會議" />
                                </div>
                                <button className="btn-primary" onClick={addForDay} style={{ height: '40px' }}>+ 新增</button>
                            </div>

                            <div>
                                <label style={{ fontSize: '0.78rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>備註</label>
                                <textarea rows={3} value={form.note} onChange={e => setForm(prev => ({ ...prev, note: e.target.value }))} placeholder="可留空" />
                            </div>

                            <div className="day-editor-list">
                                <p style={{ fontWeight: 700, fontSize: '0.9rem' }}>當日排程 ({dayEvents.length})</p>
                                {dayEvents.length === 0 ? (
                                    <p style={{ color: '#94A3B8', fontSize: '0.84rem' }}>目前是空白頁面，尚未新增排程。</p>
                                ) : dayEvents.map(function(c) {
                                    var t = new Date(c.nextContact);
                                    var hh = (t.getHours() + '').padStart(2, '0');
                                    var mm = (t.getMinutes() + '').padStart(2, '0');
                                    return (
                                        <div key={c.id} className="day-editor-item">
                                            <div className="day-editor-item-head">
                                                <strong>{hh}:{mm} | {c.name}</strong>
                                                <button className="btn-danger" style={{ padding: '0.3rem 0.6rem', fontSize: '0.78rem' }} onClick={() => removeSchedule(c.id)}>刪除排程</button>
                                            </div>
                                            <p style={{ color: '#CBD5E1', fontSize: '0.84rem' }}>{c.scheduleTitle || '（未填標題）'}</p>
                                            {c.scheduleNote && <p style={{ color: '#94A3B8', fontSize: '0.78rem', marginTop: '0.2rem' }}>{c.scheduleNote}</p>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="calendar-month-shell">
                    <div className="calendar-month-head">
                        <div>
                            <h2 className="page-title" style={{ marginBottom: '0.2rem' }}>名單排程</h2>
                            <p className="page-subtitle">點開任意日期格，會進入空白頁面新增排程</p>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.45rem' }}>
                            <button className="btn-secondary" onClick={goToday}>今天</button>
                            <button className="btn-secondary" onClick={prevMonth}>◀</button>
                            <strong style={{ minWidth: '120px', textAlign: 'center' }}>{calMonth.year}年{calMonth.month + 1}月</strong>
                            <button className="btn-secondary" onClick={nextMonth}>▶</button>
                        </div>
                    </div>

                    <div className="calendar-weekday-row">
                        {['週日', '週一', '週二', '週三', '週四', '週五', '週六'].map(w => <div key={w} className="calendar-weekday">{w}</div>)}
                    </div>

                    <div className="calendar-grid">
                        {cells.map(function(cell, idx) {
                            var key = keyOf(cell.ts);
                            var items = scheduleByDate[key] || [];
                            var isToday = cell.ts === today.getTime();
                            return (
                                <div
                                    key={idx}
                                    className={`calendar-cell${cell.otherMonth ? ' other-month' : ''}${isToday ? ' today' : ''}`}
                                    onClick={() => openDateEditor(cell.ts)}
                                >
                                    <span className="calendar-cell-date">{cell.day}</span>
                                    {items.length === 0 ? (
                                        <div className="calendar-cell-empty">點擊新增排程</div>
                                    ) : (
                                        <div>
                                            {items.slice(0, 3).map(function(c) {
                                                var t = new Date(c.nextContact);
                                                var label = (t.getHours() + '').padStart(2, '0') + ':' + (t.getMinutes() + '').padStart(2, '0');
                                                return <div key={c.id} className="calendar-event-chip">{label} {c.scheduleTitle || c.name}</div>;
                                            })}
                                            {items.length > 3 && <div className="calendar-cell-empty">+{items.length - 3} 筆</div>}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // ==================== DEAL MODAL ====================
        function DealModal({ customers, onClose, onSave, onDelete, initial }) {
            const [form, setForm] = useState(initial || { customerId: customers[0]?.id || '', title: '', value: 0, stage: 'lead', expectedClose: '', notes: '' });
            const set = (k, v) => setForm(prev => ({ ...prev, [k]: v }));
            const handleSave = () => {
                if (!form.title.trim()) return;
                onSave({ ...form, value: Number(form.value) || 0, expectedClose: form.expectedClose ? new Date(form.expectedClose).getTime() : null });
            };
            const closeDate = form.expectedClose ? (typeof form.expectedClose === 'number' ? new Date(form.expectedClose).toISOString().split('T')[0] : form.expectedClose) : '';

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" onClick={e => e.stopPropagation()}>
                        <h3 style={{ fontWeight: 700, fontSize: '1.2rem', marginBottom: '1.5rem' }}>{initial ? '交易詳情' : '新增交易'}</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>交易名稱 *</label>
                                <input value={form.title} onChange={e => set('title', e.target.value)} placeholder="例如：年度合約" />
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>關聯客戶</label>
                                <select value={form.customerId} onChange={e => set('customerId', e.target.value)}>
                                    {customers.map(c => <option key={c.id} value={c.id}>{c.name}{c.phone ? ` · ${c.phone}` : ''}</option>)}
                                </select>
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>金額</label>
                                    <input type="number" value={form.value} onChange={e => set('value', e.target.value)} />
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>預計成交日</label>
                                    <input type="date" value={closeDate} onChange={e => set('expectedClose', e.target.value)} />
                                </div>
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>階段</label>
                                <select value={form.stage} onChange={e => set('stage', e.target.value)}>
                                    <option value="lead">潛在客戶</option>
                                    <option value="contact">初次接觸</option>
                                    <option value="proposal">提案中</option>
                                    <option value="negotiation">談判中</option>
                                    <option value="closed">已成交</option>
                                </select>
                            </div>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', marginBottom: '0.25rem', display: 'block' }}>備註</label>
                                <textarea value={form.notes} onChange={e => set('notes', e.target.value)} rows={3} placeholder="交易相關備註..." />
                            </div>
                        </div>
                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', marginTop: '1.5rem' }}>
                            {onDelete && <button className="btn-danger" onClick={onDelete} style={{ marginRight: 'auto' }}>刪除交易</button>}
                            <button className="btn-secondary" onClick={onClose}>取消</button>
                            <button className="btn-primary" onClick={handleSave}>{initial ? '儲存' : '新增'}</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== FAKE DOOR MODAL ====================
        function FakeDoorModal({ onClose, title, features, wishTitle, ctx }) {
            const [fakeDoorClicks, setFakeDoorClicks] = useLocalStorage('fakeDoorClicks', {});
            const handleCatalyze = () => {
                if (wishTitle && ctx && ctx.voteWishByTitle) {
                    ctx.voteWishByTitle(wishTitle);
                }
                setFakeDoorClicks(prev => ({ ...prev, [title]: (prev[title] || 0) + 1 }));
            };
            const handleGoWish = () => {
                if (ctx && ctx.setCurrentView) {
                    ctx.setCurrentView('wishes');
                }
                onClose();
            };
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" onClick={e => e.stopPropagation()} style={{ maxWidth: 440, textAlign: 'center' }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>⚡</div>
                        <h3 style={{ fontWeight: 700, fontSize: '1.2rem', marginBottom: '0.5rem' }}>{title}</h3>
                        <p style={{ color: '#94A3B8', fontSize: '0.9rem', marginBottom: '1.5rem' }}>此功能即將開放，訂閱後可用</p>
                        <div style={{ background: 'rgba(30,41,59,0.5)', padding: '1rem', borderRadius: '10px', marginBottom: '1.5rem', textAlign: 'left' }}>
                            <p style={{ fontWeight: 600, fontSize: '0.85rem', marginBottom: '0.75rem', color: '#F97316' }}>功能預覽</p>
                            {features.map((f, i) => (
                                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.4rem', color: '#CBD5E1', fontSize: '0.85rem' }}>
                                    <span>•</span><span>{f}</span>
                                </div>
                            ))}
                        </div>
                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'center' }}>
                            <button className="btn-primary" onClick={() => { handleCatalyze(); handleGoWish(); }}>🌟 加入許願池催更</button>
                            <button className="btn-secondary" onClick={onClose}>關閉</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== COMPLETE CONTACT MODAL ====================
        function CompleteContactModal({ customer, interactions, onConfirm, onClose }) {
            const [contactMethod, setContactMethod] = useState('call');
            const [summary, setSummary] = useState('');
            const [newStatus, setNewStatus] = useState(customer.status);
            const [nextContactDate, setNextContactDate] = useState('');
            const [nextContactReason, setNextContactReason] = useState('');
            const [suggestedDate, setSuggestedDate] = useState(null);

            useEffect(() => {
                var suggested = getSuggestedNextContact(customer.status, newStatus);
                if (suggested) {
                    setSuggestedDate(suggested);
                    if (!nextContactDate) setNextContactDate(toInputDateTime(suggested));
                } else {
                    setSuggestedDate(null);
                }
            }, [newStatus]);

            var lastInter = interactions.length > 0
                ? [...interactions].sort((a, b) => b.createdAt - a.createdAt)[0]
                : null;
            var typeIcons = { call: '📞', email: '📧', meeting: '📅', note: '📝' };

            var handleConfirm = () => {
                onConfirm({
                    contactMethod: contactMethod,
                    summary: summary.trim() || '（已完成聯繫）',
                    newStatus: newStatus,
                    nextContactDate: fromInputDateTime(nextContactDate),
                    nextContactReason: nextContactReason.trim(),
                });
            };

            var methods = [
                { id: 'call', icon: '📞', label: '致電' },
                { id: 'email', icon: '📧', label: '郵件' },
                { id: 'meeting', icon: '📅', label: '會面' },
            ];

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" onClick={e => e.stopPropagation()}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1.5rem' }}>
                            <div className="avatar">{customer.name.charAt(0)}</div>
                            <div>
                                <h3 style={{ fontWeight: 700, fontSize: '1.15rem' }}>✓ 完成聯繫 — {customer.name}</h3>
                                <p style={{ color: '#94A3B8', fontSize: '0.8rem' }}>{customer.phone || ''} {customer.preference ? '· 偏好 ' + customer.preference : ''}</p>
                            </div>
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.4rem' }}>聯繫方式</label>
                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                    {methods.map(m => (
                                        <button key={m.id} onClick={() => setContactMethod(m.id)}
                                            style={{
                                                flex: 1, padding: '0.6rem', borderRadius: '8px', border: '1px solid',
                                                borderColor: contactMethod === m.id ? '#F97316' : 'rgba(148,163,184,0.2)',
                                                background: contactMethod === m.id ? 'rgba(249,115,22,0.15)' : 'rgba(30,41,59,0.6)',
                                                color: contactMethod === m.id ? '#F97316' : '#CBD5E1',
                                                cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem', transition: 'all 0.2s',
                                            }}>
                                            {m.icon} {m.label}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>聯繫摘要（選填）</label>
                                <textarea value={summary} onChange={e => setSummary(e.target.value)}
                                    rows={2} placeholder="記錄本次聯繫的重點..." />
                            </div>

                            <div>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>更新狀態</label>
                                <select value={newStatus} onChange={e => setNewStatus(e.target.value)}>
                                    {Object.entries(STATUS_MAP).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                                </select>
                            </div>

                            {suggestedDate && (
                                <div style={{ background: 'rgba(249,115,22,0.08)', border: '1px solid rgba(249,115,22,0.2)', borderRadius: '8px', padding: '0.6rem 0.75rem', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                    <span style={{ fontSize: '0.825rem', color: '#F97316' }}>💡 建議下次聯繫：{formatWeekday(suggestedDate)}</span>
                                    <button className="btn-secondary" style={{ padding: '0.25rem 0.6rem', fontSize: '0.7rem' }}
                                        onClick={() => setNextContactDate(toInputDateTime(suggestedDate))}>採用建議</button>
                                </div>
                            )}

                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.75rem' }}>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>下次聯繫日期</label>
                                    <input type="datetime-local" value={nextContactDate} onChange={e => setNextContactDate(e.target.value)} />
                                </div>
                                <div>
                                    <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>下次聯繫事由</label>
                                    <input value={nextContactReason} onChange={e => setNextContactReason(e.target.value)} placeholder="例如：確認報價回覆" />
                                </div>
                            </div>

                            {lastInter && (
                                <div style={{ background: 'rgba(30,41,59,0.4)', padding: '0.6rem 0.75rem', borderRadius: '8px', fontSize: '0.8rem' }}>
                                    <span style={{ color: '#94A3B8' }}>最近互動：</span>
                                    <span style={{ color: '#CBD5E1' }}>{typeIcons[lastInter.type] || '📝'} {lastInter.content}</span>
                                    <span style={{ color: '#64748B', marginLeft: '0.5rem' }}>({fmtTime(lastInter.createdAt)})</span>
                                </div>
                            )}
                        </div>

                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end', marginTop: '1.5rem' }}>
                            <button className="btn-secondary" onClick={onClose}>取消</button>
                            <button className="btn-complete" style={{ padding: '0.65rem 1.25rem', fontSize: '0.9rem' }} onClick={handleConfirm}>確認完成</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== RESCHEDULE MODAL ====================
        function RescheduleModal({ customer, onConfirm, onClose }) {
            const [newDate, setNewDate] = useState(toInputDateTime(customer.nextContact || Date.now()));

            var quickPicks = [
                { label: '明天', days: 1 },
                { label: '+3 天', days: 3 },
                { label: '+7 天', days: 7 },
            ];
            var applyQuick = (days) => {
                var d = new Date();
                d.setDate(d.getDate() + days);
                d.setHours(10, 0, 0, 0);
                setNewDate(toInputDateTime(d.getTime()));
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" style={{ maxWidth: 420 }} onClick={e => e.stopPropagation()}>
                        <h3 style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: '1.25rem' }}>📅 改期 — {customer.name}</h3>
                        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem' }}>
                            {quickPicks.map(p => (
                                <button key={p.days} className="btn-secondary" style={{ flex: 1 }}
                                    onClick={() => applyQuick(p.days)}>{p.label}</button>
                            ))}
                        </div>
                        <div style={{ marginBottom: '1.25rem' }}>
                            <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>自訂日期時間</label>
                            <input type="datetime-local" value={newDate} onChange={e => setNewDate(e.target.value)} />
                        </div>
                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>
                            <button className="btn-secondary" onClick={onClose}>取消</button>
                            <button className="btn-primary" onClick={() => onConfirm(fromInputDateTime(newDate))}>確認改期</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== ADD SCHEDULE MODAL ====================
        function AddScheduleModal({ customers, prefilledCustomerId, prefilledDate, onConfirm, onClose }) {
            const [customerId, setCustomerId] = useState(prefilledCustomerId || '');
            const [schedDate, setSchedDate] = useState(prefilledDate ? toInputDateTime(prefilledDate) : '');
            const [schedTitle, setSchedTitle] = useState('');
            const [schedNote, setSchedNote] = useState('');

            var selectedCustomer = customers.find(c => c.id === customerId);
            var quickPicks = [
                { label: '明天', days: 1 },
                { label: '+3 天', days: 3 },
                { label: '+7 天', days: 7 },
            ];
            var applyQuick = (days) => {
                var d = new Date(); d.setDate(d.getDate() + days); d.setHours(10, 0, 0, 0);
                setSchedDate(toInputDateTime(d.getTime()));
            };
            var handleSubmit = () => {
                if (!customerId || !schedDate) return;
                onConfirm(customerId, { date: fromInputDateTime(schedDate), title: schedTitle.trim(), note: schedNote.trim() });
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-box" style={{ maxWidth: 480 }} onClick={e => e.stopPropagation()}>
                        <h3 style={{ fontWeight: 700, fontSize: '1.15rem', marginBottom: '1.25rem' }}>
                            📅 新增排程{selectedCustomer ? ' — ' + selectedCustomer.name : ''}
                        </h3>

                        {!prefilledCustomerId && (
                            <div style={{ marginBottom: '1rem' }}>
                                <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>客戶</label>
                                <select value={customerId} onChange={e => setCustomerId(e.target.value)}>
                                    <option value="">— 請選擇客戶 —</option>
                                    {customers.map(c => <option key={c.id} value={c.id}>{c.name}{c.phone ? ' (' + c.phone + ')' : ''}</option>)}
                                </select>
                            </div>
                        )}

                        <div style={{ marginBottom: '0.75rem' }}>
                            <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>日期</label>
                            <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                {quickPicks.map(p => (
                                    <button key={p.days} className="btn-secondary" style={{ flex: 1, padding: '0.4rem' }}
                                        onClick={() => applyQuick(p.days)}>{p.label}</button>
                                ))}
                            </div>
                            <input type="datetime-local" value={schedDate} onChange={e => setSchedDate(e.target.value)} />
                        </div>

                        <div style={{ marginBottom: '0.75rem' }}>
                            <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>標題</label>
                            <input value={schedTitle} onChange={e => setSchedTitle(e.target.value)} placeholder="例如：確認報價回覆" />
                        </div>

                        <div style={{ marginBottom: '1.25rem' }}>
                            <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>筆記</label>
                            <textarea value={schedNote} onChange={e => setSchedNote(e.target.value)} rows={3}
                                placeholder="準備什麼、要討論什麼..." />
                        </div>

                        <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>
                            <button className="btn-secondary" onClick={onClose}>取消</button>
                            <button className="btn-primary" onClick={handleSubmit}
                                style={(!customerId || !schedDate) ? { opacity: 0.5, cursor: 'not-allowed' } : {}}>新增排程</button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==================== LOCKED PRO SECTION ====================
        function LockedProSection({ title, items }) {
            return (
                <div className="locked-section" style={{ marginBottom: '0.75rem' }}>
                    <div style={{ position: 'relative', zIndex: 0 }}>
                        <h4 style={{ fontWeight: 600, fontSize: '0.85rem', marginBottom: '0.5rem' }}>{title}</h4>
                        {items.map((item, i) => (
                            <div key={i} style={{ background: 'rgba(30,41,59,0.3)', padding: '0.5rem', borderRadius: '6px', marginBottom: '0.3rem', fontSize: '0.8rem', color: '#94A3B8' }}>
                                {item}
                            </div>
                        ))}
                    </div>
                    <div className="locked-overlay">
                        <span style={{ fontSize: '1.5rem', marginBottom: '0.35rem' }}>🔒</span>
                        <span className="pro-badge" style={{ marginBottom: '0.35rem' }}>PRO</span>
                        <p style={{ color: '#CBD5E1', fontSize: '0.75rem' }}>訂閱解鎖此功能</p>
                    </div>
                </div>
            );
        }

        // ==================== VOICE RECORDING (LOCKED) ====================
        function VoiceRecording() {
            return (
                <div>
                    <div style={{ marginBottom: '1.5rem' }}>
                        <h2 className="page-title">🎤 語音記錄</h2>
                        <p className="page-subtitle">此功能已暫時鎖定，避免誤觸造成卡頓</p>
                    </div>
                    <div className="card" style={{ textAlign: 'center', padding: '2.5rem 1.5rem' }}>
                        <div style={{ fontSize: '2.5rem', marginBottom: '0.75rem' }}>🔒</div>
                        <p style={{ fontWeight: 700, fontSize: '1.1rem', marginBottom: '0.5rem' }}>語音記錄暫停使用</p>
                        <p style={{ color: '#94A3B8', fontSize: '0.9rem' }}>目前已停用錄音與音檔儲存，以提升整體流暢度。</p>
                    </div>
                </div>
            );
        }

        // ==================== TEAM MANAGEMENT ====================
        function TeamManagement({ ctx }) {
            const { team, toast, handleAddTeamMember, handleRemoveTeamMember } = ctx;
            const [selectedMember, setSelectedMember] = useState(null);
            const [addEmail, setAddEmail] = useState('');
            const [addLoading, setAddLoading] = useState(false);
            const [addError, setAddError] = useState('');

            const totalValue = team.reduce((s, m) => s + m.value, 0);
            const sorted = [...team].sort((a, b) => b.value - a.value);

            const handleAdd = async function(e) {
                e.preventDefault();
                if (!addEmail.trim()) return;
                setAddError('');
                setAddLoading(true);
                try {
                    await handleAddTeamMember(addEmail.trim());
                    setAddEmail('');
                } catch (err) {
                    setAddError(err.message || '新增失敗');
                }
                setAddLoading(false);
            };

            const handleRemove = async function(memberId, memberName) {
                if (!confirm('確定要移除「' + memberName + '」？')) return;
                try { await handleRemoveTeamMember(memberId); } catch (err) { toast('移除失敗', 'error'); }
            };

            const detail = selectedMember ? team.find(m => m.id === selectedMember) : null;

            return (
                <div>
                    <div style={{ marginBottom: '1.5rem' }}>
                        <h2 className="page-title">👔 團隊管理</h2>
                        <p className="page-subtitle">管理下線成員，查看團隊業績</p>
                    </div>

                    {/* 新增下線 */}
                    <div className="card" style={{ marginBottom: '1.5rem' }}>
                        <h3 style={{ fontWeight: 600, fontSize: '1.05rem', marginBottom: '0.75rem' }}>新增下線</h3>
                        <form onSubmit={handleAdd} style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                            <input type="email" value={addEmail} onChange={e => setAddEmail(e.target.value)}
                                placeholder="輸入下線的註冊 Email" required className="auth-input" style={{ flex: 1 }} />
                            <button type="submit" className="btn-primary" disabled={addLoading}
                                style={{ padding: '0.65rem 1.25rem', fontSize: '0.9rem', whiteSpace: 'nowrap' }}>
                                {addLoading ? '處理中...' : '新增'}
                            </button>
                        </form>
                        {addError && <p style={{ color: '#EF4444', fontSize: '0.8rem', marginTop: '0.5rem' }}>{addError}</p>}
                    </div>

                    {team.length > 0 ? (
                        <>
                            {/* 團隊業績總覽 */}
                            <div className="card" style={{ marginBottom: '1.5rem' }}>
                                <h3 style={{ fontWeight: 600, fontSize: '1.05rem', marginBottom: '0.75rem' }}>團隊業績總覽</h3>
                                <div style={{ display: 'flex', gap: '1.5rem', flexWrap: 'wrap' }}>
                                    <div>
                                        <p style={{ color: '#94A3B8', fontSize: '0.8rem' }}>下線人數</p>
                                        <p style={{ fontSize: '1.5rem', fontWeight: 700, color: '#F97316' }}>{team.length}</p>
                                    </div>
                                    <div>
                                        <p style={{ color: '#94A3B8', fontSize: '0.8rem' }}>總成交金額</p>
                                        <p style={{ fontSize: '1.5rem', fontWeight: 700, color: '#F97316' }}>${totalValue.toLocaleString()}</p>
                                    </div>
                                    <div>
                                        <p style={{ color: '#94A3B8', fontSize: '0.8rem' }}>總成交筆數</p>
                                        <p style={{ fontSize: '1.5rem', fontWeight: 700, color: '#F97316' }}>{team.reduce((s, m) => s + m.deals, 0)}</p>
                                    </div>
                                    <div>
                                        <p style={{ color: '#94A3B8', fontSize: '0.8rem' }}>總客戶數</p>
                                        <p style={{ fontSize: '1.5rem', fontWeight: 700, color: '#F97316' }}>{team.reduce((s, m) => s + m.totalCustomers, 0)}</p>
                                    </div>
                                </div>
                            </div>

                            {/* 下線列表 */}
                            <div className="card">
                                <h3 style={{ fontWeight: 600, fontSize: '1.05rem', marginBottom: '1rem' }}>👥 下線列表</h3>
                                {sorted.map((member, index) => (
                                    <div key={member.id}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.85rem', background: selectedMember === member.id ? 'rgba(249,115,22,0.1)' : 'rgba(30,41,59,0.35)', borderRadius: '10px', marginBottom: '0.5rem', cursor: 'pointer', transition: 'all 0.2s' }}
                                            onClick={() => setSelectedMember(selectedMember === member.id ? null : member.id)}>
                                            <span style={{ fontSize: '1.3rem', minWidth: '1.75rem', textAlign: 'center' }}>
                                                {index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}`}
                                            </span>
                                            <div className="avatar avatar-sm">{member.name.charAt(0)}</div>
                                            <div style={{ flex: 1 }}>
                                                <p style={{ fontWeight: 600, fontSize: '0.9rem' }}>{member.name}</p>
                                                <p style={{ color: '#94A3B8', fontSize: '0.75rem' }}>{member.email}</p>
                                                <p style={{ color: '#94A3B8', fontSize: '0.8rem', marginTop: '0.15rem' }}>
                                                    {member.totalCustomers} 位客戶 · {member.totalDeals} 筆交易 · {member.deals} 筆成交 · ${member.value.toLocaleString()}
                                                </p>
                                            </div>
                                            <button className="btn-secondary" style={{ padding: '0.25rem 0.5rem', fontSize: '0.7rem', color: '#EF4444', borderColor: 'rgba(239,68,68,0.3)' }}
                                                onClick={e => { e.stopPropagation(); handleRemove(member.id, member.name); }}>移除</button>
                                        </div>

                                        {/* 展開詳情 */}
                                        {selectedMember === member.id && detail && (
                                            <div style={{ padding: '0.75rem 1rem', marginBottom: '0.75rem', background: 'rgba(30,41,59,0.2)', borderRadius: '10px', border: '1px solid rgba(148,163,184,0.1)' }}>
                                                <div style={{ display: 'flex', gap: '1.5rem', marginBottom: '1rem' }}>
                                                    <div>
                                                        <h4 style={{ fontWeight: 600, fontSize: '0.9rem', marginBottom: '0.5rem' }}>客戶列表 ({detail.customers.length})</h4>
                                                        {detail.customers.length === 0 && <p style={{ color: '#64748B', fontSize: '0.8rem' }}>尚無客戶</p>}
                                                        {detail.customers.slice(0, 10).map(c => (
                                                            <div key={c.id} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.35rem 0', fontSize: '0.8rem' }}>
                                                                <span>{c.name || '未命名'}</span>
                                                                <span style={{ color: '#94A3B8' }}>{c.phone || ''}</span>
                                                                <span className={'badge ' + (STATUS_MAP[c.status]?.badge || 'badge-info')} style={{ fontSize: '0.65rem' }}>
                                                                    {STATUS_MAP[c.status]?.label || c.status}
                                                                </span>
                                                            </div>
                                                        ))}
                                                        {detail.customers.length > 10 && <p style={{ color: '#64748B', fontSize: '0.75rem', marginTop: '0.25rem' }}>...還有 {detail.customers.length - 10} 位</p>}
                                                    </div>
                                                    <div>
                                                        <h4 style={{ fontWeight: 600, fontSize: '0.9rem', marginBottom: '0.5rem' }}>交易管道 ({detail.allDeals.length})</h4>
                                                        {detail.allDeals.length === 0 && <p style={{ color: '#64748B', fontSize: '0.8rem' }}>尚無交易</p>}
                                                        {detail.allDeals.slice(0, 10).map(d => (
                                                            <div key={d.id} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.35rem 0', fontSize: '0.8rem' }}>
                                                                <span>{d.title || '未命名'}</span>
                                                                <span style={{ color: '#F97316', fontWeight: 600 }}>${(d.value || 0).toLocaleString()}</span>
                                                                <span className="badge badge-info" style={{ fontSize: '0.65rem' }}>{d.stage}</span>
                                                            </div>
                                                        ))}
                                                        {detail.allDeals.length > 10 && <p style={{ color: '#64748B', fontSize: '0.75rem', marginTop: '0.25rem' }}>...還有 {detail.allDeals.length - 10} 筆</p>}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </>
                    ) : (
                        <div className="card" style={{ textAlign: 'center', padding: '3rem 2rem' }}>
                            <p style={{ fontSize: '2.5rem', marginBottom: '1rem' }}>👥</p>
                            <p style={{ fontWeight: 600, fontSize: '1.1rem', marginBottom: '0.5rem' }}>尚無下線成員</p>
                            <p style={{ color: '#94A3B8' }}>在上方輸入下線的 Email 來建立團隊</p>
                        </div>
                    )}
                </div>
            );
        }

        // ==================== PLUGIN STORE ====================
        function PluginStore() {
            const [installed, setInstalled] = useState([]);
            const toast = useToast();
            const handleInstall = (plugin) => {
                if (installed.includes(plugin.id)) {
                    setInstalled(prev => prev.filter(id => id !== plugin.id));
                    toast(`已移除「${plugin.name}」`);
                } else {
                    setInstalled(prev => [...prev, plugin.id]);
                    toast(`已安裝「${plugin.name}」`);
                }
            };
            return (
                <div>
                    <div style={{ marginBottom: '1.5rem' }}>
                        <h2 className="page-title">🏪 功能商店</h2>
                        <p className="page-subtitle">擴充你的 CRM 功能</p>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: '1rem' }}>
                        {seedPlugins.map(plugin => (
                            <div key={plugin.id} className="card card-lift">
                                <div style={{ fontSize: '2.5rem', marginBottom: '0.75rem' }}>{plugin.icon}</div>
                                <h3 style={{ fontWeight: 700, fontSize: '1.05rem', marginBottom: '0.35rem' }}>{plugin.name}</h3>
                                <p style={{ color: '#94A3B8', fontSize: '0.825rem', marginBottom: '0.75rem' }}>{plugin.description}</p>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', marginBottom: '0.75rem' }}>
                                    <span style={{ color: '#F59E0B' }}>⭐</span>
                                    <span style={{ fontWeight: 600, fontSize: '0.9rem' }}>{plugin.rating}</span>
                                    <span style={{ color: '#94A3B8', fontSize: '0.8rem' }}>({plugin.reviews.toLocaleString()})</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                    <div>
                                        <span style={{ fontSize: '1.25rem', fontWeight: 700, color: '#F97316' }}>${plugin.price}</span>
                                        <span style={{ color: '#94A3B8', fontSize: '0.8rem' }}>/月</span>
                                    </div>
                                    <button className={installed.includes(plugin.id) ? 'btn-secondary' : 'btn-primary'}
                                        style={{ padding: '0.4rem 1rem', fontSize: '0.825rem' }}
                                        onClick={() => handleInstall(plugin)}>
                                        {installed.includes(plugin.id) ? '已安裝 ✓' : '安裝'}
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ==================== WISH POOL ====================
        function WishPool({ ctx }) {
            const { wishes, voteWish, setWishes, toast } = ctx;
            const [showAdd, setShowAdd] = useState(false);
            const handleVote = (id) => { voteWish(id); };
            const handleAdd = (wish) => {
                setWishes(prev => [{ ...wish, id: genId(), votes: 1, comments: 0, status: 'voting', daysAgo: 0 }, ...prev]);
                setShowAdd(false);
                toast('許願已發起！');
            };
            const sorted = [...wishes].sort((a, b) => b.votes - a.votes);

            return (
                <div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1.5rem', flexWrap: 'wrap', gap: '1rem' }}>
                        <div>
                            <h2 className="page-title">🌟 功能許願池</h2>
                            <p className="page-subtitle">告訴我們你需要什麼功能</p>
                        </div>
                        <button className="btn-primary" onClick={() => setShowAdd(true)}>＋ 發起許願</button>
                    </div>

                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.25rem', flexWrap: 'wrap' }}>
                        <span className="badge badge-primary" style={{ padding: '0.35rem 0.75rem' }}>全部 ({wishes.length})</span>
                        <span className="badge badge-info" style={{ padding: '0.35rem 0.75rem' }}>規劃中 ({wishes.filter(w=>w.status==='planned').length})</span>
                        <span className="badge badge-warning" style={{ padding: '0.35rem 0.75rem' }}>評估中 ({wishes.filter(w=>w.status==='evaluating').length})</span>
                        <span className="badge badge-success" style={{ padding: '0.35rem 0.75rem' }}>待投票 ({wishes.filter(w=>w.status==='voting').length})</span>
                    </div>

                    {sorted.map(wish => (
                        <div key={wish.id} className="card" style={{ marginBottom: '0.75rem' }}>
                            <div style={{ display: 'flex', gap: '0.75rem' }}>
                                <button className="vote-button" onClick={() => handleVote(wish.id)} style={{ flexDirection: 'column', padding: '0.5rem 0.75rem', minWidth: 60 }}>
                                    <span>👍</span>
                                    <span style={{ fontWeight: 700, fontSize: '0.95rem' }}>{wish.votes}</span>
                                </button>
                                <div style={{ flex: 1 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem', alignItems: 'flex-start', flexWrap: 'wrap', gap: '0.5rem' }}>
                                        <h3 style={{ fontWeight: 700, fontSize: '1.05rem' }}>{wish.title}</h3>
                                        <span className={`badge badge-${wish.status === 'planned' ? 'info' : wish.status === 'evaluating' ? 'warning' : 'success'}`}>
                                            {wish.status === 'planned' ? '🔵 規劃中' : wish.status === 'evaluating' ? '🟡 評估中' : '🟢 待投票'}
                                        </span>
                                    </div>
                                    {wish.description && <p style={{ color: '#CBD5E1', fontSize: '0.85rem', marginBottom: '0.5rem' }}>{wish.description}</p>}
                                    <div style={{ display: 'flex', gap: '0.75rem', fontSize: '0.8rem', color: '#94A3B8' }}>
                                        <span>by {wish.author}</span>
                                        <span>·</span>
                                        <span>{wish.daysAgo} 天前</span>
                                        <span>·</span>
                                        <span>💬 {wish.comments} 則留言</span>
                                        <span>·</span>
                                        <span className="badge" style={{ background: 'rgba(30,41,59,0.5)', color: '#94A3B8', fontSize: '0.7rem' }}>{wish.category}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}

                    {showAdd && (
                        <div className="modal-overlay" onClick={() => setShowAdd(false)}>
                            <div className="modal-box" onClick={e => e.stopPropagation()}>
                                <h3 style={{ fontWeight: 700, fontSize: '1.2rem', marginBottom: '1.5rem' }}>🌟 發起新許願</h3>
                                <WishForm onSubmit={handleAdd} onCancel={() => setShowAdd(false)} />
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function WishForm({ onSubmit, onCancel }) {
            const [form, setForm] = useState({ title: '', category: '通訊整合', author: '我', description: '' });
            const set = (k, v) => setForm(prev => ({ ...prev, [k]: v }));
            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                    <div>
                        <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>功能標題 *</label>
                        <input value={form.title} onChange={e => set('title', e.target.value)} placeholder="例如：Instagram 私訊整合" />
                    </div>
                    <div>
                        <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>分類</label>
                        <select value={form.category} onChange={e => set('category', e.target.value)}>
                            <option>通訊整合</option><option>數據分析</option><option>自動化</option><option>產業專用</option><option>AI 助手</option><option>其他</option>
                        </select>
                    </div>
                    <div>
                        <label style={{ fontSize: '0.8rem', color: '#94A3B8', display: 'block', marginBottom: '0.25rem' }}>詳細說明</label>
                        <textarea value={form.description} onChange={e => set('description', e.target.value)} rows={3} placeholder="描述你希望的功能..." />
                    </div>
                    <div style={{ display: 'flex', gap: '0.75rem', justifyContent: 'flex-end' }}>
                        <button className="btn-secondary" onClick={onCancel}>取消</button>
                        <button className="btn-primary" onClick={() => form.title.trim() && onSubmit(form)}>送出許願</button>
                    </div>
                </div>
            );
        }

        // ==================== RENDER ====================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


